const mongoose = require('mongoose');
const container = require("../configurations/container");
const Subscriber = mongoose.model('Subscriber');
const Subscription = mongoose.model('Subscription');
const BillingHistory = mongoose.model('BillingHistory');
const User = mongoose.model('User');

const createCsvWriter = require('csv-writer').createObjectCsvWriter;
const fs = require('fs');
const csvParser = require('csv-parser');

const billinghistoryRepo = container.resolve('billingHistoryRepository');
const subscriptionRepo = container.resolve('subscriptionRepository');

var nodemailer = require('nodemailer');
var usersRepo = container.resolve('userRepository');
var viewLogsRepo = require('../repos/ViewLogRepo');

var pageViews = require('../controllers/PageViews');
const SubscriberRepository = require('./SubscriberRepo');
const { resolve } = require('path');


let currentDate = null;
currentDate = getCurrentDate();

let paywallTotalBase = currentDate+"_PaywallTotalBase.csv";
let paywallTotalBaseFilePath = `./${paywallTotalBase}`;

let ActiveBase = currentDate+"_ActiveBase.csv";
let ActiveBaseFilePath = `./${ActiveBase}`;

let paywallExpiredBase = currentDate+"_PaywallExpiredBase.csv";
let paywallExpiredBaseFilePath = `./${paywallExpiredBase}`;

let paywallInActiveBase = currentDate+"_PaywallInActiveBase.csv";
let paywallInActiveBaseFilePath = `./${paywallInActiveBase}`;

let paywallRevFileName = currentDate+"_PaywallRevReport.csv";
let paywallRevFilePath = `./${paywallRevFileName}`;

let paywallUnsubReport = currentDate+"_UnsubReport.csv";
let paywallUnsubFilePath = `./${paywallUnsubReport}`;

let paywallChannelWiseUnsubReport = currentDate+"_ChannelWiseUnsub.csv";
let paywallChannelWiseUnsubReportFilePath = `./${paywallChannelWiseUnsubReport}`;

let paywallChannelWiseTrial = currentDate+"_ChannelWiseTrial.csv";
let paywallChannelWiseTrialFilePath = `./${paywallChannelWiseTrial}`;

let paywallErrorCountReport = currentDate+"_ErrorCountReport.csv";
let paywallErrorCountFilePath = `./${paywallErrorCountReport}`;

let paywallErrorCountReportBySource = currentDate+"_ErrorCountReportBySource.csv";
let paywallErrorCountBySourceFilePath = `./${paywallErrorCountReportBySource}`;

let paywallFullAndPartialChargedReport = currentDate+"_FullAndPartialCharged.csv";
let paywallFullAndPartialChargedReportFilePath = `./${paywallFullAndPartialChargedReport}`;

let paywallCallbackReport = currentDate+"_CallbackReport.csv";
let paywallCallbackFilePath = `./${paywallCallbackReport}`;

let paywallTrialToBilledUsers = currentDate+"_TrialToBilled.csv";
let paywallTrialToBilledUsersFilePath = `./${paywallTrialToBilledUsers}`;

let affiliatePvs = currentDate+"_AffiliatePageViews.csv";
let affiliatePvsFilePath = `./${affiliatePvs}`;

let dailyNetAdditionCsv = currentDate+"_DailyNetAdditions.csv";
let dailyNetAdditionFilePath = `./${dailyNetAdditionCsv}`;

let usersReportWithTrialAndBillingHistory = currentDate+"_UsersReportWithTrialAndBillingHistory.csv";
let usersReportWithTrialAndBillingHistoryFilePath = `./${usersReportWithTrialAndBillingHistory}`;

let dateWiseChargingDetails = currentDate+"_DateWiseChargingDetails.csv";
let dateWiseChargingDetailsFilePath = `./${dateWiseChargingDetails}`;
let dateWiseChargingDetailsWriter = createCsvWriter({
    path: dateWiseChargingDetailsFilePath,
    header: [
        {id: 'date', title: 'Date'},
        {id: "count",title: "Billing Count" }
    ]
});



let randomReport = currentDate+"_RandomReport.csv";
let randomReportFilePath = `./${randomReport}`;

const csvWriter = createCsvWriter({
    path: paywallRevFilePath,
    header: [
        {id: 'date', title: 'Date'},
        {id: 'newUser', title: 'Number Verified Users'},
        {id: 'newSubscriber', title: 'New Subscribers'},
        {id: 'totalSubscribers', title: 'Total Subscribers'},
        {id: 'trials', title: 'Trials Activated'},
        {id: 'tempTotalActiveSubscribers',title: 'Total Active Subscribers'},

        {id: 'liveOnlyCount', title: 'Live Daily'},
        {id: 'liveWeeklyCount', title: 'Live Weekly'},
        {id: 'comedyOnlyCount', title: 'Comedy Daily'},
        {id: 'comedyWeeklyCount', title: 'Comedy Weekly'},

        {id: 'liveOnlyRevenue', title: 'Live Daily Revenue'},
        {id: 'liveWeeklyRevenue', title: 'Live Weekly Revenue'},
        {id: 'comedyOnlyRevenue', title: 'Comedy Daily Revenue'},
        {id: 'comedyWeeklyRevenue', title: 'Comedy Weekly Revenue'},
        {id: 'totalRevenue',title: 'Total Revenue'}

    ]
});

const monthNames = ["January", "February", "March", "April", "May", "June",
  "July", "August", "September", "October", "November", "December"
];

const dailyNetAdditionWriter = createCsvWriter({
    path: dailyNetAdditionFilePath,
    header: [
        {id: 'date', title: 'Date'},
        {id: 'subs', title: 'Subscriptions'},
        {id: "unsubs",title: "Un-Subscriptions" },
        {id: "net",title: "Net Subscriptions" },
    ]
});

const csvReportWriter = createCsvWriter({
    path: paywallCallbackFilePath,
    header: [
        {id: 'tid', title: 'TID'},
        {id: 'mid', title: 'MID'},
        {id: "isValidUser",title: "Is Valid Telenor User" },
        {id: "isCallbAckSent",title: "IS CallBack Sent" },
        {id: 'added_dtm', title: 'User TIMESTAMP'},
        {id: 'callBackSentTime', title: 'TIMESTAMP'}
    ]
});

const csvTotalBase = createCsvWriter({
    path: paywallTotalBaseFilePath,
    header: [
        {id: 'msisdn', title: 'Msisdn'},
    ]
});

const csvExpiredBase = createCsvWriter({
    path: paywallExpiredBaseFilePath,
    header: [
        {id: 'msisdn', title: 'Msisdn'},
    ]
});

const csvInActiveBase = createCsvWriter({
    path: paywallInActiveBaseFilePath,
    header: [
        {id: 'msisdn', title: 'Msisdn'},
    ]
});

const ActiveBaseWriter = createCsvWriter({
    path: ActiveBaseFilePath,
    header: [
        {id: 'msisdn', title: 'Msisdn'},
    ]
});

const csvFullAndPartialCharged = createCsvWriter({
    path: paywallFullAndPartialChargedReportFilePath,
    header: [
        {id: 'date', title: 'Date'},
        {id: 'fully_charged_users', title: 'Fully Charged Users'},
        {id: "partially_charged_users",title: "Partially Charged Users" },
        {id: 'total', title: 'Total'}
    ]
});

const csvTrialToBilledUsers = createCsvWriter({
    path: paywallTrialToBilledUsersFilePath,
    header: [
        {id: 'trial_date', title: 'Trial Activation Date'},
        {id: 'billed_date', title: "Successfull Billing Date"},
        //{id: 'msisdn', title: 'List of MSISDNs'},
        {id: 'total', title: 'Total Count'}
    ]
});

const randomReportWriter = createCsvWriter({
    path: randomReportFilePath,
    header: [
        {id: 'msisdn', title: 'Msisdn'},
        {id: 'acquisition_source', title: 'Acquisition Source'},
        {id: 'acquisition_date', title: 'Acquisition Date'},
        {id: 'number_of_success_charging', title: 'No of time user successfully charged'},
        {id: "unsub_date",title: "Unsubscription Date" }
    ]
});

const csvAffiliatePvs = createCsvWriter({
    path: affiliatePvsFilePath,
    header: [
        {id: 'date', title: 'Date'},
        {id: 'source',title: "Source"},
        {id: 'mid',title: "MID"},
        {id: 'count', title: "Page Views"},
    ]
});

const usersReportWithTrialAndBillingHistoryWriter = createCsvWriter({
    path: usersReportWithTrialAndBillingHistoryFilePath,
    header: [
        {id: 'mid', title: 'Mid'},
        {id: 'user_id',title: "Auto Generated Id"},
        {id: 'code',title: "Code"},
        {id: 'success_transactions', title: "Success Transactions"},
        {id: 'amount', title: "Amount"},
    ]
});

var transporter = nodemailer.createTransport({
    host: "mail.dmdmax.com.pk",
    port: 465,
    secure: true, // true for 465, false for other ports
    auth: {
      user: 'reports@goonj.pk', // generated ethereal user
      pass: 'YiVmeCPtzJn39Mu' // generated ethereal password
    }
});

generateReportForAcquisitionSourceAndNoOfTimeUserBilled4 = async() => {
    console.log("=> generateReportForAcquisitionSourceAndNoOfTimeUserBilled4");
    
    let finalResult = [];
    let inputData = [
        "03460445180","03436145774","03487337292","03444926041","03447912870","03479548636","03442953128","03426365072","03467209438","03455127526","03455362682","03452298002","03449216039","03449291595","03475495922","03422711940","03456372434","03492369179","03464110383","03457814418","03443151536","03435145658","03435060087","03332369261","03461583178","03456284102","03430586459","03495158371","03401403858","03430417178","03451406549","03448026058","03445420542","03459811523","03472022791","03444389866","03441628010","03448530215","03428597789","03466894675","03436179084","03462144798","03426649477","03072253679","03481274700","03478430986","03467036177","03489809105","03452361106","03458772400","03465858580","03449441129","03423137319","03495007662","03448671579","03413929451","03472986519","03493143061","03453799950","03466654500","03466676468","03466466634","03485600542","03441313128","03421330471","03462580585","03450980300","03456666917","03453373001","03419693465","03369832732","03446093265","03417885679","03442573856","03454325279","03424661476","03457607337","03472887522","03477345750","03434430172","03423203306","03404850369","03484094104","03483522112","03426465817","03452436121","03408639516","03034018585","03415535771","03452749534","03026071684","03494984186","03457411599","03413984727","03009468288","03410745428","03344474789","03406309614","03434538826","03438413100","03461067052","03464699546","03445358159","03494815696","03455700447","03336350816","03457182159","03445637086","03459995264","03420182432","03457567789","03442046308","03425889206","03412168402","03467280694","03457899642","03410029575","03466312240","03475127589","03033951020","03447660435","03446900551","03455506603","03425957311","03465541863","03462130351","03458043313","03477941026","03438590950","03457017316","03496597141","03428883722","03468673161","03481952892","03457777647","03458906878","03417792478","03406246711","03499694002","03477902796","03430561513","03404255140","03459873208","03495041450","03005369532","03492498851","03448687465","03467759420","03431549705","03477844978","03065712100","03451545209","03413097139","03411499872","03469723423","03474000909","03416421057","03418207970","03430917693","03459274400","03419843442","03419468032","03414048422","03436363385","03489810341","03439890679","03441769208","03459832496","03473467499","03443949058","03414515152","03489665998","03476667667","03404926609","03449795420","03472879688","03438776767","03498248939","03462544091","03486582766","03475180791","03427964872","03329424733","03464364874","03436692463","03464846837","03468230027","03437530688","03466001303","03427956065","03458847896","03489245188","03456545765","03427997153","03410297764","03467279919","03478452358","03465511546","03004295843","03442449746","03442490133","03456660492","03426400110","03442374335","03461512971","03453720487","03483426235","03459706396","03049035228","03009593818","03459328521","03416665958","03425470781","03404858613","03432110950","03426824798","03479105394","03499194360","03433637710","03484175455","03443285614","03453042855","03432969793","03432021334","03404665443","03466723293","03360499583","03473119305","03443962174","03467454574","03454245036","03444011911","03462681310","03497396252","03409375736","03427865036","03418975375","03463326321","03471411204","03486971964","03461920620","03467870243","03423094862","03007559831","03471114415","03426755825","03453614419","03441744652","03452855245","03414387507","03486075982","03422239055","03142394083","03052799503","03498237722","03461464645","03410608871","03416909246","03480357402","03487828128","03469596350","03438096899","03482229762","03457437311","03454105395","03415721381","03440979785","03455362982","03427584334","03427584334","03430595536","03155514786","03446074416","03466816996","03454643996","03478100855","03484759977","03446872526","03334844031","03027445430","03401380866","03474560434","03454819326","03460431110","03466044671","03446722360","03338140950","03431378700","03431666036","03492426224","03455339881","03484760249","03436257846","03428468358","03464084558","03429019448","03456756843","03455959566","03444781784","03425685749","03467870243","03400859134","03469455562","03489197389","03417862714","03423215507","03454219825","03494396510","03427279947","03427428021","03473864818","03417008318","03453637528","03453567593","03427407960","03006585262","03457928689","03464901476","03184158540","03452873289","03401680631","03457001136","03455852062","03113255753","03016033657","03436100163","03437673399","03453672313","03483784164","03466908609","03485913733","03413659574","03413097139","03453964036","03419303084","03485945473","03493133483","03484386719","03452388983","03487016480","03439366703","03445746400","03401077556","03045233979","03442981133","03437440326","03422975530","03473839388","03482593811","03479340364","03480104210","03085188088","03418410593","03486045293","03403213178","03464676659","03235724215","03494488560","03478368283","03443397935","03438500206","03452423054","03481412066","03454229414","03461448185","03449383415","03449517907","03492534807","03444455051","03471059911","03484187544","03402106328","03480476598","03441096180","03437116438","03467021713","03464674922","03419788471","03457938764","03489902730","03458282400","03419051889","03413792405","03414437205","03452048487","03400115876","03403452146","03347405766","03466380886","03402085053","03494122202","03460681276","03476048101","03444975661","03489172814","03463883975","03461113776","03484580982","03404092194","03442233711","03428588277","03498008573","03418447164","03430667242","03487922850","03459494180","03401452021","03456769884","03424439458","03444985718","03437219789","03066130279","03455379928","03453647251","03413886786","03022785104","03467505393","03498026845","03482735493","03491012829","03496271591","03405794139","03433645208","03420761197"
    ];
    
    try{
        for(let i = 0; i < inputData.length; i++){
            if(inputData[i] && inputData[i].length === 11){
                let singleRecord = await usersRepo.getData(inputData[i]);
                if(singleRecord.length > 0){
                    singleRecord = singleRecord[0];
                    let singObject = {
                        msisdn: singleRecord.msisdn,
                        acquisition_date: singleRecord.acquisition_date,
                        number_of_success_charging: singleRecord.total_successful_chargings
                    };
    
                    if(singleRecord.acquisition_mid){
                        singObject.acquisition_source = singleRecord.acquisition_mid;
                    }else{
                        if(singleRecord.acquisition_source === 'affiliate_web'){
                            singObject.acquisition_source = 'web';
                        }else{
                            singObject.acquisition_source = singleRecord.acquisition_source;
                        }
                        
                    }
            
                    let expiryHistory = {};
                    if(singleRecord.subscription_status === 'expired'){
                        expiryHistory = await billinghistoryRepo.getExpiryHistory(singleRecord.user_id);
                        if(expiryHistory.length >= 2){
                            expiryHistory.sort(function(a,b){
                                return new Date(b.billing_dtm) - new Date(a.billing_dtm);
                            });
                        }
            
                        singObject.unsub_date = expiryHistory[0].billing_dtm;
                    }
        
                    finalResult.push(singObject);
                    console.log("=> Data done for item ", i);
                }
            }else{
                console.log("=> Invalid number or number length");
            }
        }
    
        console.log("=> Sending email");
        await randomReportWriter.writeRecords(finalResult);
        let info = await transporter.sendMail({
            from: 'paywall@dmdmax.com.pk',
            to:  ["farhan.ali@dmdmax.com"],
            subject: `Complaint Data`, // Subject line
            text: `This report contains the details of msisdns being sent us over email from Zara`,
            attachments:[
                {
                    filename: randomReport,
                    path: randomReportFilePath
                }
            ]
        });
    
        console.log("=> [randomReport][emailSent]",info);
        fs.unlink(randomReportFilePath,function(err,data) {
            if (err) {
                console.log("=> File not deleted[randomReport]");
            }
            console.log("=> File deleted [randomReport]");
        });
    }catch(e){
        console.log("=> error - ",JSON.stringify(e));
    }
}

generateReportForAcquisitionSourceAndNoOfTimeUserBilled3 = async() => {
    console.log("=> generateReportForAcquisitionSourceAndNoOfTimeUserBilled3");
    
    let finalResult = [];
    let inputData = [
        "03418239010","03430226358","03446797075","03491248235","03461397435","03034943189","03017967871","03376246635","03439042286","03013068101","03029827002","03453724924","03439572570","03420914802","03454315125","03448872537","03418740491","03027445430","03457731844","03461202149","03470793466","03413360035","03458565325","03466354253","03005731341","03474952793","03409217133","03458741391","03472119123","03469436772","03481265667","03436762889","03411803769","03420395848","03410119574","03433273019","03482769399","03057187205","03426760903","03456369764","03459641656","03466605558","03411622088","03447543224","03425606349","03458056987","03454411088","03458087606","03414750483","03404893059","03412971764","03414789873","03485621448","03462586448","03456966351","0302340233","03007843525","03414443786","03459635628","03426305458","03016929327","03484971894","03466028209","03452576872","03417133201","03450730036","03453203306","03477923936","03428641692","03498442504","03449541061","03417923408","03420620425","03455594439","03488859214","03421241051","03449063660","03412389971","03463702470","03431178402","03445635585","03454442456","03334851038","03430258471","03474244197","03492828617","03475946696","03458666702","03419159422","03416079697","03468697176","03415632783","03222324125","03412511252","03455949992","03219034660","03419338268","03459819159","03450499221","03457798530","03472115840","03226368390","03408760714","03313260839","03459162671","03466434231","03457722231","03483630885","03453073866","03466558572","03424802084","03430947554","03457912276","03457174553","03457174553","03430053378","03433457116","03424368050","03453035611","03465169967","03451172275","03463075418","03456280089","03469648386","03414166104","03425466610","03476114644","03463044106","03434076500","03473547230","03472438669","03447299580","03464771889","03441050327","03437524781","03445797368","03453463070","03415608362","03441401733","03467000100","03453007461","03453599438","03468670885","03446024457","03454814885","03464466370","03422992858","03467954417","03400548239","03458107513","03441725639","03456107255","03497100052","03410640316","03476040010","03460660402","03450381573","03464096573","03423100837","03466399809","03434239202","03457900034","03455123831","03416767618","03451313060","03453236377","03474600400","03425476973","03427433426","03412167818","03213008144","03423586780","03431674162","03473274440","03456205746","03483700833","03462550179","03485157309","03454101792","03329234822","03489599695","03482627891","03484211584","03458817580","03453403426","03453403426","03453403426","03440730948","03470696645","03424482354","03428645379","03456737747","03494290939","03417770407","03422513855","03455197297","03415560357","03475116313","03349930765","03457561374","03495622431","03421784163","03463475391","03468773989","03465236794","03466621601","03470994942","03431460199","03455794284","03413216772","03404528619","03435920947","03453303395","03456996611","03431674162","03405555728","03333623322","03435671624","03453480702","03454158675","03481512702","03463406380","03437473316","03465729685","03418404011","03426365645","03466611146","03478271147","03480755318","03466337383","03484110353","03474030136","03485805535","03478121335","03435478028","03456551142","03421917705","03403321918","03469776531","03427204036","03414812067","03497743938","03455492200","03461409584","03434530646","03411212995","03457553405","03497441930","03417052409","03456000445","03465866739","03006539102","03486456191","03434713152","03448872537","03498822085","03441017667","03460216202","03411244969","03411199603","03453930614","03444223945","03469726174","03419651343","03436721040","03455113494","03435781075","03438913782","03430502668","03441492557","03401116211","03443375970","03412068501","03425226629","03448170709","03494037759","03429998314","03490074009","03482461795","03488218406","03442865379","03466221972","03478098277","03418476952","03435748088","03413630194","03492914570","03454798928","03072617329","03483953522","03441213157","03219071073","03402330709","03441274199","03449548498","03465279146","03408041528","03469241015","03446507101","03496275663","03448283136","03413248687","03416981363","03472845088","03436868768","03412039019","03465936582","03401125259","03470568096","03428084881","03456509646","03454826042","03435383722","03082289170","03423724541","03477327875","03498474117","03453131500","03436518025","03484341690","03444616353","03409603351","03467780489","03414878560","03318372192","03476495035","03314723396","03417065699","03428090580","03487090836","03434684547","03421401963","03460989707","03437474575","03462987857","03467835707","03434447604","03435946570","03450988025","03454444678","03408532872","03335767314","03480460602","03467266903","03454739440","03092544035","03439182268","03491226100","03414376820","03425381598","03414394091","03444223045","03472290776","03440211435","03437659547","03006194899","03478690597","03476962907","03442951650","03454158675","03494659349","03468517104","03476343417","03453131500","03489585650","03137574328","03415818975","03455518975","03446040059","03450655738","03404744048","03448866662","03429430989","03492650586","03413002363","03413810281","03447583915","03436466296","03444968483","03457273185","03488205372","03422175520","03498952503","03454697143","03469664483","03105735001","03436610454","03453202248","03451327713","03436461635","03440507361","03488715352","03426922612","03449313677","03452845352","03474418316","03426308168","03135759159","03444803496","03465712673","03044894397","03484382082","03466364845","03458081678","03457273877","03401916439","03431145303","03467160723","03438464668","03472704861","03488646168","03477118273","03497754484","03433103072","03488018977","03430937957","03405184660","03126553155","03462785471","03431536671","03421539023","03001680006","03433929700","03451185617","03452104893","03403388608","03418717211","03453946181","03448287944","03446136850","03406735237","03439481610","03435500626","03436453889","03430687799","03477748121","03427175737","03443455124","03459215924","03466049913","03449720543","03470985697","03422930955","03475502437","03009886094","03409115241","03479272572","03484187544","03469347882","03416746894","03474728038","03456643235","03445316826","03441677447","03434503405","03466253971","03023587147","03467194346","03458062355","03410171817","03458752381","03454877553","03413501189","03444334278","03455396915","03462626391","03417577478","03461505892","03498449283","03443760015","03459406591","03467160723","03403737768","03433497996","03478993642","03464041236","03494556543","03465073156","03469259459","03431925485","03458062393","03484250059","03415207412","03219712565","03466922878","03434720008","03415521214","03468876272","03465151786","03434898547","03445708992","03468077863","03467484252","03406577555","03453536716","03431242483","03006734651","03451242490","03428965052","03139463176","03442961840"
    ];
    
    try{
        for(let i = 0; i < inputData.length; i++){
            if(inputData[i] && inputData[i].length === 11){
                let singleRecord = await usersRepo.getData(inputData[i]);
                if(singleRecord.length > 0){
                    singleRecord = singleRecord[0];
                    let singObject = {
                        msisdn: singleRecord.msisdn,
                        acquisition_date: singleRecord.acquisition_date,
                        number_of_success_charging: singleRecord.total_successful_chargings
                    };
    
                    if(singleRecord.acquisition_mid){
                        singObject.acquisition_source = singleRecord.acquisition_mid;
                    }else{
                        if(singleRecord.acquisition_source === 'affiliate_web'){
                            singObject.acquisition_source = 'web';
                        }else{
                            singObject.acquisition_source = singleRecord.acquisition_source;
                        }
                        
                    }
            
                    let expiryHistory = {};
                    if(singleRecord.subscription_status === 'expired'){
                        expiryHistory = await billinghistoryRepo.getExpiryHistory(singleRecord.user_id);
                        if(expiryHistory.length >= 2){
                            expiryHistory.sort(function(a,b){
                                return new Date(b.billing_dtm) - new Date(a.billing_dtm);
                            });
                        }
            
                        singObject.unsub_date = expiryHistory[0].billing_dtm;
                    }
        
                    finalResult.push(singObject);
                    console.log("=> Data done for item ", i);
                }
            }else{
                console.log("=> Invalid number or number length");
            }
        }
    
        console.log("=> Sending email");
        await randomReportWriter.writeRecords(finalResult);
        let info = await transporter.sendMail({
            from: 'paywall@dmdmax.com.pk',
            to:  ["farhan.ali@dmdmax.com"],
            subject: `Complaint Data`, // Subject line
            text: `This report contains the details of msisdns being sent us over email from Zara`,
            attachments:[
                {
                    filename: randomReport,
                    path: randomReportFilePath
                }
            ]
        });
    
        console.log("=> [randomReport][emailSent]",info);
        fs.unlink(randomReportFilePath,function(err,data) {
            if (err) {
                console.log("=> File not deleted[randomReport]");
            }
            console.log("=> File deleted [randomReport]");
        });
    }catch(e){
        console.log("=> error - ",JSON.stringify(e));
    }
}

generateReportForAcquisitionSourceAndNoOfTimeUserBilled2 = async() => {
    console.log("=> generateReportForAcquisitionSourceAndNoOfTimeUserBilled2");
    
    let finalResult = [];
    let inputData = [
        "03407354508" ,"03458070426" ,"03408891606" ,"03411407226" ,"03497044564" ,"03449659242" ,"03421631705" ,"03479106199" ,"03487967709" ,"03454974506" ,"03414429464" ,"03445301225" ,"03413132063" ,"03415376117" ,"03453614891" ,"03456465004" ,"03423165184" ,"03454336875" ,"03445698396" ,"03444087415" ,"03410715783" ,"03457138542" ,"03443096080" ,"03059334433" ,"03484154691" ,"03446627791" ,"03490763621" ,"03434067614" ,"03474471560" ,"03444569998" ,"03471981601" ,"03449203912" ,"03464024344" ,"03427653463" ,"03487223236" ,"03458319532" ,"03446140583" ,"03474437668" ,"03490786891" ,"03486269760" ,"03477344277" ,"03446616953" ,"03470322285" ,"03404288731" ,"03499126156" ,"03458604252" ,"03462627476" ,"03400505037" ,"03434349041" ,"03447580880" ,"03448502269" ,"03434010695" ,"03432727347" ,"03463692192" ,"03436462654" ,"03014733951" ,"03014112608" ,"03446875313" ,"03417079398" ,"03486622800" ,"03446094966" ,"03467986089" ,"03452999323" ,"03499003346" ,"03478785257" ,"03214272702" ,"03496194916" ,"03478890957" ,"03451487226" ,"03497509768" ,"03455904825" ,"03417562740" ,"03471823651" ,"03493390241" ,"03420853900" ,"03464865569" ,"03478989647" ,"03428253870" ,"03417126429" ,"03444933650" ,"03410989684" ,"03437469910" ,"03453667229" ,"03494088281" ,"03463178402" ,"03468413526" ,"03448391718" ,"03481570854" ,"03444571121" ,"03439705337" ,"03442761636" ,"03416269594" ,"03430790127" ,"03442617709" ,"03464921835" ,"03466926786" ,"03488819245" ,"03428365806" ,"03465239182" ,"03477500061" ,"03462141970" ,"03449784846" ,"03497839210" ,"03410068757" ,"03447061436" ,"03497441930" ,"03439647752" ,"03484885955" ,"03459519086" ,"03449191203" ,"03412719127" ,"03406916633" ,"03427701449" ,"03445116575" ,"03466655644" ,"03474683705" ,"03438729707" ,"03435153343" ,"03455332393" ,"03457013417" ,"03450549659" ,"03403723076" ,"03495882476" ,"03427316923" ,"03476189198" ,"03479081722" ,"03466633752" ,"03479548636" ,"03467195061" ,"03423885098" ,"03447268176" ,"03416708635" ,"03451296692" ,"03443856711" ,"03329757412" ,"03473555933" ,"03456940682" ,"03435234235" ,"03415089564" ,"03413664207" ,"03469677996" ,"03439500672" ,"03477056263" ,"03499418102" ,"03417932740" ,"03452298828" ,"03082178963" ,"03477465005" ,"03477424899" ,"03499209040" ,"03423952994" ,"03468858745" ,"03493368902" ,"03490019430" ,"03499397928" ,"03434989918" ,"03482042662" ,"03468839421" ,"03477571699" ,"03456963973" ,"03495746634" ,"03474739515" ,"03482129162" ,"03477196550" ,"03444333953" ,"03433077412" ,"03442791848" ,"03408646210" ,"03444809342" ,"03427724932" ,"03445390116" ,"03436841277" ,"03446840065" ,"03489136399" ,"03431535434" ,"03447451267" ,"03495007561" ,"03481455345" ,"03415616479" ,"03468658306" ,"03476581498" ,"03499583730" ,"03457372215" ,"03462578927" ,"03424609917" ,"03434483397" ,"03485812797" ,"03469490904" ,"03465373964" ,"03463838614" ,"03491641218" ,"03453521921" ,"03444642281" ,"03457485364" ,"03479111203" ,"03216018147" ,"03464786028" ,"03482866800" ,"03471921019" ,"03487441432" ,"03102641486" ,"03432084219" ,"03436082898" ,"03421445717" ,"03440912298" ,"03466318984" ,"03404624520" ,"03423888645" ,"03404892426" ,"03413916732" ,"03462086658" ,"03435946570" ,"03440206121" ,"03408720643" ,"03473038001" ,"03491485088" ,"03459541581" ,"03476529844" ,"03447121208" ,"03425792686" ,"03458634057" ,"03404449499" ,"03466453258" ,"03447519039" ,"03484282844" ,"03444028027" ,"03442883895" ,"03426192056" ,"03424634951" ,"03468177532" ,"03464950823" ,"03459617359" ,"03438230798" ,"03475604676" ,"03414605960" ,"03455305557" ,"03474989489" ,"03455845528" ,"03401833331" ,"03411433054" ,"03403213178" ,"03433342418" ,"03412521117" ,"03491169793" ,"03405412439" ,"03449177711" ,"03455630582" ,"03407216827" ,"03437648055" ,"03478457390" ,"03402148445" ,"03496001903" ,"03452792468" ,"03446250991" ,"03424286241" ,"03234265213" ,"03421461303" ,"03404656211" ,"03461385285" ,"03468006981" ,"03435918199" ,"03494910336" ,"03486203179" ,"03449439248" ,"03457711575" ,"03416700592" ,"03448330088" ,"03467669477" ,"03470116240" ,"03459887405" ,"03492645513" ,"03478940719" ,"03448467292" ,"03489745557" ,"03464237372" ,"03409790552" ,"03445404700" ,"03461566145" ,"03457744804" ,"03448921100" ,"03429325389" ,"03461256674" ,"03414850489" ,"03456981563" ,"03439185365" ,"03466805794" ,"03328873883" ,"03411035661" ,"03410648726" ,"03475536696" ,"03414850489" ,"03489648737" ,"03067891071" ,"03434413419" ,"03494041878" ,"03499453519" ,"03488192755" ,"03362646668" ,"03456996054" ,"03444983364" ,"03400482009" ,"03453481520" ,"03439246211" ,"03466475227" ,"03455058952" ,"03446601985" ,"03443092604" ,"03457855297" ,"03446669748" ,"03429535841" ,"03452318352" ,"03417459755" ,"03438188782" ,"03491141314" ,"03454702186" ,"03416298115" ,"03456127358" ,"03454649967" ,"03464183210" ,"03444406815" ,"03497672819" ,"03457848843" ,"03466473375" ,"03481999068" ,"03462017995" ,"03416280508" ,"03428820522" ,"03449813944" ,"03446247185" ,"03362799110" ,"03451268977" ,"03434518060" ,"03484995817" ,"03427895292" ,"03469355591" ,"03477772047" ,"03484781171" ,"03472123518" ,"03434813567" ,"03483799399" ,"03432868268" ,"03469824022" ,"03474336616" ,"03401177072" ,"03463410369" ,"03457213313" ,"03464242650" ,"03444291732" ,"03459472304" ,"03476100910" ,"03415328705" ,"03409859944" ,"03409014362" ,"03437078957" ,"03468670880" ,"03426663486" ,"03443203252" ,"03432205455" ,"03414932440" ,"03447614145" ,"03150010789" ,"03126363471" ,"03333125788" ,"03417069630" ,"03436651843" ,"03449112225" ,"03445348275" ,"03457906717" ,"03411588401" ,"03498311668" ,"03454230055" ,"03454220089" ,"03454369112" ,"03426908515" ,"03456724434" ,"03484546781" ,"03498254048" ,"03400142121" ,"03435543437" ,"03467462724" ,"03457524246" ,"03450786203" ,"03402608624" ,"03454537890" ,"03423747295" ,"03456706697" ,"03402821647" ,"03423981200" ,"03432042732" ,"03211607852" ,"03421618456" ,"03471259148" ,"03472499884" ,"03444807834" ,"03132810653" ,"03435557381" ,"03209207345" ,"03403577062" ,"03458780060" ,"03065126457" ,"03403577062" ,"03478952645" ,"03498448206" ,"03424072047" ,"03246457549" ,"03484050611" ,"03469490107" ,"03486059921" ,"03458940246" ,"03464761129" ,"03459815856" ,"03444900062" ,"03490409685" ,"03442589982" ,"03425467975" ,"03488329842" ,"03474837046" ,"03450749315" ,"03457774424" ,"03466318984" ,"03456706697" ,"03428627371" ,"03460456849" ,"03446917615" ,"03405739122" ,"03412040667" ,"03494814780" ,"03484271045" ,"03466793185" ,"03457800173" ,"03451394609" ,"03417400260" ,"03469635360" ,"03469709552" ,"03426065895" ,"03465558132" ,"03449862281" ,"03466138684" ,"03214938003" ,"03495308478" ,"03424462636" ,"03460684609" ,"03469815405" ,"03454359424" ,"03449089707" ,"03483647223" ,"03076768490" ,"03491222924" ,"03439995467" ,"03408069077" ,"03480714271" ,"03453688374" ,"03485283387" ,"03455233172" ,"03455503678" ,"03405617707" ,"03406161001" ,"03466474640" ,"03412217102" ,"03483597700" ,"03484464238" ,"03486466926" ,"03439159067" ,"03460595429" ,"03457807269" ,"03438388455" ,"03360205121" ,"03435673115" ,"03437907280" ,"03448992315" ,"03487648632" ,"03440432093" ,"03420400980" ,"03435076854" ,"03414549879" ,"03458595182" ,"03439216360" ,"03436868768" ,"03015852520" ,"03456739955" ,"03492139746" ,"03426384445" ,"03428523566" ,"03462654112" ,"03480031443" ,"03456309775" ,"03443633346" ,"03496648393" ,"03466858079" ,"03433825651" ,"03471210610" ,"03450042011" ,"03488418515" ,"03444010055" ,"03464596340" ,"03459137457" ,"03422567434" ,"03432086435" ,"03459823341" ,"03417167861" ,"03489634117" ,"03476572262" ,"03471000522" ,"03423124528" ,"03433905375" ,"03465204937" ,"03499418029" ,"03446674344" ,"03423283070" ,"03458151478" ,"03077098098" ,"03411565574" ,"03482815900" ,"03451694149" ,"03454223703" ,"03422940768" ,"03448000087" ,"03429480559" ,"03469353004" ,"03486382030" ,"03488195922" ,"03407018184" ,"03456020817" ,"03420286289" ,"03475172377" ,"03486931041" ,"03166260364" ,"03438737037" ,"03404904308" ,"03336000507" ,"03410018783" ,"03480307532" ,"03420586286" ,"03467238288" ,"03430434464" ,"03454353938" ,"03075975949" ,"03411932707" ,"03463590042" ,"03472187250" ,"03454014581" ,"03425006342" ,"03474595560" ,"03462352498" ,"03470343844" ,"03456771560" ,"03424256019" ,"03312537122" ,"03456364033" ,"03456307286" ,"03423066765" ,"03486363532" ,"03497264290" ,"03435365868" ,"03418405846" ,"03461926608" ,"03407066012" ,"03457984137" ,"03472889348" ,"03458816110" ,"03449639423" ,"03458011398" ,"03402364465" ,"03430748494" ,"03412726680" ,"03466204642" ,"03488426694" ,"03324146449" ,"03443065721" ,"03455799890" ,"03489845097" ,"03456797430" ,"03430835265" ,"03468264587" ,"03479507055" ,"03436964448" ,"03426668535" ,"03434258762" ,"03458603337" ,"03458755334" ,"03462654817" ,"03401576551" ,"03453607417" ,"03457879751" ,"03445339540" ,"03418346653" ,"03425901030" ,"03136972430" ,"03473848950" ,"03427705721" ,"03436037234" ,"03410018783" ,"03444200829" ,"03484342787" ,"03464724154" ,"03409791595" ,"03472863453" ,"03468480959" ,"03456387198" ,"03464132507" ,"03432970034" ,"03492047753" ,"03458073640" ,"03484539892" ,"03494108965" ,"03411545175" ,"03472400016" ,"03305490557" ,"03453234638" ,"03467307429" ,"03426772389" ,"03449816556" ,"03456850713" ,"03464857799" ,"03455941499" ,"03459798755" ,"03444263566" ,"03464725796" ,"03464986140" ,"03432349795" ,"03432822186" ,"03466560178" ,"03470832002" ,"03468415691" ,"03409404847" ,"03444310952" ,"03456195362" ,"03173244520" ,"03453512462" ,"03485913733" ,"03451941527" ,"03462086405" ,"03468811370" ,"03465752878" ,"03443070415" ,"03453444999" ,"03482173532" ,"03459389933" ,"03470745751" ,"03215091791" ,"03499675449" ,"03406794761" ,"03436709304" ,"03002457000" ,"03488873917" ,"03454817086" ,"03447583915" ,"03454126998" ,"03426114125" ,"03452886105" ,"03458299555" ,"03452888654" ,"0302948035"
    ];
    
    try{
        for(let i = 0; i < inputData.length; i++){
            if(inputData[i] && inputData[i].length === 11){
                let singleRecord = await usersRepo.getData(inputData[i]);
                if(singleRecord.length > 0){
                    singleRecord = singleRecord[0];
                    let singObject = {
                        msisdn: singleRecord.msisdn,
                        acquisition_date: singleRecord.acquisition_date,
                        number_of_success_charging: singleRecord.total_successful_chargings
                    };
    
                    if(singleRecord.acquisition_mid){
                        singObject.acquisition_source = singleRecord.acquisition_mid;
                    }else{
                        if(singleRecord.acquisition_source === 'affiliate_web'){
                            singObject.acquisition_source = 'web';
                        }else{
                            singObject.acquisition_source = singleRecord.acquisition_source;
                        }
                        
                    }
            
                    let expiryHistory = {};
                    if(singleRecord.subscription_status === 'expired'){
                        expiryHistory = await billinghistoryRepo.getExpiryHistory(singleRecord.user_id);
                        if(expiryHistory.length >= 2){
                            expiryHistory.sort(function(a,b){
                                return new Date(b.billing_dtm) - new Date(a.billing_dtm);
                            });
                        }
            
                        singObject.unsub_date = expiryHistory[0].billing_dtm;
                    }
        
                    finalResult.push(singObject);
                    console.log("=> Data done for item ", i);
                }
            }else{
                console.log("=> Invalid number or number length");
            }
        }
    
        console.log("=> Sending email");
        await randomReportWriter.writeRecords(finalResult);
        let info = await transporter.sendMail({
            from: 'paywall@dmdmax.com.pk',
            to:  ["farhan.ali@dmdmax.com"],
            subject: `Complaint Data`, // Subject line
            text: `This report contains the details of msisdns being sent us over email from Zara`,
            attachments:[
                {
                    filename: randomReport,
                    path: randomReportFilePath
                }
            ]
        });
    
        console.log("=> [randomReport][emailSent]",info);
        fs.unlink(randomReportFilePath,function(err,data) {
            if (err) {
                console.log("=> File not deleted[randomReport]");
            }
            console.log("=> File deleted [randomReport]");
        });
    }catch(e){
        console.log("=> error - ",JSON.stringify(e));
    }
}

generateReportForAcquisitionSourceAndNoOfTimeUserBilled = async() => {
    console.log("=> generateReportForAcquisitionSourceAndNoOfTimeUserBilled");
    
    let finalResult = [];
    let inputData = [
        "03450790688" ,"03432661690" ,"03476265307" ,"03456774270" ,"03474911158" ,"03457088218" ,"03457206163" ,"03482106235" ,"03426571684" ,"03464623291" ,"03422924227" ,"03486822415" ,"03149494502" ,"03485331411" ,"03465141621" ,"03005687996" ,"03462674858" ,"03441166540" ,"03336743544" ,"03410435320" ,"03477340179" ,"03416679788" ,"03434983754" ,"03440040777" ,"03474623540" ,"03490463595" ,"03434783233" ,"03445619808" ,"03446044024" ,"03446587584" ,"03460274032" ,"03424628987" ,"03474987665" ,"03426344126" ,"03457176446" ,"03457029192" ,"03491495323" ,"03452221669" ,"03023527081" ,"03402064958" ,"03445792127" ,"03481160493" ,"03403062200" ,"03458824167" ,"03104080035" ,"03472355291" ,"03423970755" ,"03496229459" ,"03449117733" ,"03442324274" ,"03439700460" ,"03465125703" ,"03456162916" ,"03414120620" ,"03429908046" ,"03414442223" ,"03418885806" ,"03442120436" ,"03439634540" ,"03486411671" ,"03430766527" ,"03440029882" ,"03444677345" ,"03428120159" ,"03406941112" ,"03456123208" ,"03403329003" ,"03455332600" ,"03488381727" ,"03489057090" ,"03333730403" ,"03340747990" ,"03445199769" ,"03425540045" ,"03435669319" ,"03427737877" ,"03424454314" ,"03478177183" ,"03467522555" ,"03429612735" ,"03338003571" ,"03400800910" ,"03410312802" ,"03422697530" ,"03450248066" ,"03143778496" ,"03427615313" ,"03457757455" ,"03404283052" ,"03339848584" ,"03459500510" ,"03457613627" ,"03468704861" ,"03454842301" ,"03470879091" ,"03450414559" ,"03468865082" ,"03463914390" ,"03433083576" ,"03476991906" ,"03457465839" ,"03415545870" ,"03473240359" ,"03075055976" ,"03433287683" ,"03423361471" ,"03435125392" ,"03474169245" ,"03411505785" ,"03485796955" ,"03412003347" ,"03433929700" ,"03451279623" ,"03443710150" ,"03449598878" ,"03425474706" ,"03447354002" ,"03417789728" ,"03316700613" ,"03454091869" ,"03407884510" ,"03445701439" ,"03455848154" ,"03436856203" ,"03012443737" ,"03474169245" ,"03470095574" ,"03463954829" ,"03401113657" ,"03496398324" ,"03467357430" ,"03446405515" ,"03464994843" ,"03433030385" ,"03468233366" ,"03456745709" ,"03427774042" ,"03413342174" ,"03414494026" ,"03464054728" ,"03455056732" ,"03465676615" ,"03407884510" ,"03417601690" ,"03459000463" ,"03453778628" ,"03493468913" ,"03413511963" ,"03426060865" ,"03452656576" ,"03438236720" ,"03433416660" ,"03424218440" ,"03435050801" ,"03497548146" ,"03400905081" ,"03466024167" ,"03413332097" ,"03404090941" ,"03469567865" ,"03086339564" ,"03467083157" ,"03454816379" ,"03457396411" ,"03443885884" ,"03491990708" ,"03458827762" ,"03468978682" ,"03434206403" ,"03012443737" ,"03456578520" ,"03497508662" ,"03455269652" ,"03335605421" ,"03457513061" ,"03480430239" ,"03432153930" ,"03418631071" ,"03454615599" ,"03480605437" ,"03461463138" ,"03469402697" ,"03433011959" ,"03495788291" ,"03403199007" ,"03443888663" ,"03454659729" ,"03481910416" ,"03470891193" ,"03426277481" ,"03406348671" ,"03406322632" ,"03430786505" ,"03467996997" ,"03494344403" ,"03438966771" ,"03442919910" ,"03464289166" ,"03469680692" ,"03470305457" ,"03464289166" ,"03408047309" ,"03441258430" ,"03437603159" ,"03439455786" ,"03481986380" ,"03442366638" ,"03466248909" ,"03461727970" ,"03464289166" ,"03469853808" ,"03439874146" ,"03429376042" ,"03481013518" ,"03454098665" ,"03008814055" ,"03453630582" ,"03426958780" ,"03487373768" ,"03441153102" ,"03410622297" ,"03459740842" ,"03430300036" ,"03425646070" ,"03453623819" ,"03116614726" ,"03465107187" ,"03232671501" ,"03336738150" ,"03450622770" ,"03468266782" ,"03359010910" ,"03498901799" ,"03454171157" ,"03456001254" ,"03490989287" ,"03404991409" ,"03446351669" ,"03495491300" ,"03460233835" ,"03461356116" ,"03484155037" ,"03463599774" ,"03459386833" ,"03433056782" ,"03414545529" ,"03429991834" ,"03484543054" ,"03415061981" ,"03421587139" ,"03490477037" ,"03404125432" ,"03454416002" ,"03425352479" ,"03351425001" ,"03484134664" ,"03462567001" ,"03174563947" ,"03435965196" ,"03454835105" ,"03419793614" ,"03462628275" ,"03478402313" ,"03443919200" ,"03418700439" ,"03407207121" ,"03490558521" ,"03479340151" ,"03486072066" ,"03457131978" ,"03410730000" ,"03009155791" ,"03427445206" ,"03427770970" ,"03467086816" ,"03450564975" ,"03476538066" ,"03314131952" ,"03224489614" ,"03474311783" ,"03444501386" ,"03457273051" ,"03456635033" ,"03482300431" ,"03469896476" ,"03434244334" ,"03436051668" ,"03433971658" ,"03430448836" ,"03477581592" ,"03468061728" ,"03433632068" ,"03438023927" ,"03441084498" ,"03413495394" ,"03423427037" ,"03442867873" ,"03434244334" ,"03452412243" ,"03437828942" ,"03464402766" ,"03421540201" ,"03474365378" ,"03409623882" ,"03445355705" ,"03430018095" ,"03441700649" ,"03441182687" ,"03497069243" ,"03452297283" ,"03467485214" ,"03446016068" ,"03430270325" ,"03454938304" ,"03458176344" ,"03478090551" ,"03450915511" ,"03458763042" ,"03457898680" ,"03413847691" ,"03007756523" ,"03427729722" ,"03469114698" ,"03496866147" ,"03462004911" ,"03441487521" ,"03457008544" ,"03496014499" ,"03472335243" ,"03419512309" ,"03479164429" ,"03477314547" ,"03446714161" ,"03453670353" ,"03446105404" ,"03472629109" ,"03414093912" ,"03417126429" ,"03459333801" ,"03434479187" ,"03438966513" ,"03478881659" ,"03449370224" ,"03445413455" ,"03479715215" ,"03454943091" ,"03440579411"
    ];
    
    try{
        for(let i = 0; i < inputData.length; i++){
            if(inputData[i] && inputData[i].length === 11){
                let singleRecord = await usersRepo.getData(inputData[i]);
                if(singleRecord.length > 0){
                    singleRecord = singleRecord[0];
                    let singObject = {
                        msisdn: singleRecord.msisdn,
                        acquisition_date: singleRecord.acquisition_date,
                        number_of_success_charging: singleRecord.total_successful_chargings
                    };
    
                    if(singleRecord.acquisition_mid){
                        singObject.acquisition_source = singleRecord.acquisition_mid;
                    }else{
                        if(singleRecord.acquisition_source === 'affiliate_web'){
                            singObject.acquisition_source = 'web';
                        }else{
                            singObject.acquisition_source = singleRecord.acquisition_source;
                        }
                        
                    }
            
                    let expiryHistory = {};
                    if(singleRecord.subscription_status === 'expired'){
                        expiryHistory = await billinghistoryRepo.getExpiryHistory(singleRecord.user_id);
                        if(expiryHistory.length >= 2){
                            expiryHistory.sort(function(a,b){
                                return new Date(b.billing_dtm) - new Date(a.billing_dtm);
                            });
                        }
            
                        singObject.unsub_date = expiryHistory[0].billing_dtm;
                    }
        
                    finalResult.push(singObject);
                    console.log("=> Data done for item ", i);
                }
            }else{
                console.log("=> Invalid number or number length");
            }
        }
    
        console.log("=> Sending email");
        await randomReportWriter.writeRecords(finalResult);
        let info = await transporter.sendMail({
            from: 'paywall@dmdmax.com.pk',
            to:  ["farhan.ali@dmdmax.com"],
            subject: `Complaint Data`, // Subject line
            text: `This report contains the details of msisdns being sent us over email from Zara`,
            attachments:[
                {
                    filename: randomReport,
                    path: randomReportFilePath
                }
            ]
        });
    
        console.log("=> [randomReport][emailSent]",info);
        fs.unlink(randomReportFilePath,function(err,data) {
            if (err) {
                console.log("=> File not deleted[randomReport]");
            }
            console.log("=> File deleted [randomReport]");
        });
    }catch(e){
        console.log("=> error - ",JSON.stringify(e));
    }
}

dailyReport = async(mode = 'prod') => {

    let resultToWriteToCsv= [];

    try{
        console.log("=> dailyReport");
        let today = new Date();
        let myToday = new Date(today.getFullYear(),today.getMonth(),today.getDate(),0,0,0);

        let dayBeforeYesterday = new Date(today.getFullYear(),today.getMonth(),today.getDate(),0,0,0);
        dayBeforeYesterday.setDate(dayBeforeYesterday.getDate() - 1);
        let reportStartDate = new Date("2020-02-07T00:00:00.672Z");
        let susbcriberStats = await Subscription.aggregate([
            {
                "$match": 
                {
                    "added_dtm": { "$gte": reportStartDate ,$lt: myToday  },
                    "active": true
                }
            },
            {$group: {_id: {"day": {"$dayOfMonth" : "$added_dtm"}, "month": { "$month" : "$added_dtm" },"year":{ $year: "$added_dtm" } } , count:{ $sum: 1 } } },
            {$project: {  "date":{"$dateFromParts":{ year: "$_id.year","month":"$_id.month","day":"$_id.day" }}, "count": "$count",_id:-1 }} ,
            { $sort: {"date": -1}}
        ]);

        console.log("=> dailyReport 1");
        
        let subscription_status_stats = await Subscription.aggregate([
            {
                "$match": 
                {
                    "added_dtm": { "$gte": reportStartDate ,$lt: myToday  },
                    active:true
                }
            },
            {$group: {_id: {subscription_status: "$subscription_status" } , count:{ $sum: 1 } } },
            {$project: {  "count": "$count",_id: 1 }} ,
            { $sort: {"date": -1}}
        ]);

        console.log("=> dailyReport 2");

        let totalActiveSubscribers = subscription_status_stats.reduce((accum,elem) => {
            if (elem._id.subscription_status === "trial" || elem._id.subscription_status === "graced" || elem._id.subscription_status === "billed") {
                return accum = accum + elem.count; 
            }
            return accum;
        },0);

        console.log("=> dailyReport 3");

        let userStats = await User.aggregate([
                {
                    "$match": 
                    {
                        "added_dtm": { "$gte": reportStartDate ,$lt: myToday  },
                        active:true,
                        operator:"telenor"
                    }
                },
            {$group: {_id: {"day": {"$dayOfMonth" : "$added_dtm"}, "month": { "$month" : "$added_dtm" },
            "year":{ $year: "$added_dtm" }} , count:{ $sum: 1 } } },
            {$project: {  "date":{"$dateFromParts":{ year: "$_id.year","month":"$_id.month","day":"$_id.day" }}, "count": "$count",_id:-1 }},
            {$sort: {"date": -1}} 
        ]);

        console.log("=> dailyReport 4");

        let totalUserStats = await User.countDocuments({ "added_dtm": { "$gte": reportStartDate ,$lt: myToday  },active:true } );
        console.log("=> dailyReport 4.1");
        let totalSubscriberStats = await Subscription.countDocuments({ "added_dtm": { "$gte": reportStartDate ,$lt: myToday  },active:true } );
        console.log("=> dailyReport 4.2 - ", totalSubscriberStats);
        let totalExpiredCount = await BillingHistory.countDocuments({"billing_dtm": { "$gte": reportStartDate ,$lt: myToday  },billing_status: "expired"} );
        console.log("=> dailyReport 5 - ", totalExpiredCount);

        let billingStats = await BillingHistory.aggregate([
                { $match: { "billing_status": {$in : ["Success","expired"]}, "billing_dtm": { "$gte": reportStartDate ,$lt: myToday  } } },
                {$group: {_id: {"day": {"$dayOfMonth" : "$billing_dtm"}, "month": { "$month" : "$billing_dtm" },
                    "year":{ $year: "$billing_dtm" },billing_status: "$billing_status",package_id: "$package_id" } , revenue:{ $sum: "$price" },count:{$sum: 1} } },
                {$project: {  "date":{"$dateFromParts":{ year: "$_id.year","month":"$_id.month","day":"$_id.day" }},
                    "revenue": "$revenue","count":"$count",_id:-1 }},{$sort: {"date": -1}}
        ]);
        
        console.log("=> dailyReport 6");
        
        let trialStats = await BillingHistory.aggregate([
            { $match: { "billing_status": "trial","billing_dtm": { "$gte": reportStartDate ,$lt: myToday  }  } },
            {$group: {_id: {"day": {"$dayOfMonth" : "$billing_dtm"}, "month": { "$month" : "$billing_dtm" },
                "year":{ $year: "$billing_dtm" } } , trials:{ $sum: 1 } } },
            {$project: {  "date":{"$dateFromParts":{ year: "$_id.year","month":"$_id.month","day":"$_id.day" }}, 
                "trials": "$trials",_id:-1 }},{$sort: {"date": -1}}
        ]);
        
        console.log("=> dailyReport 7");

        let resultToWrite = {};
        userStats.forEach(userStat => {
            if(userStat.date){
                resultToWrite[userStat.date.toDateString()] =  {};
            }
        });

        console.log("=> dailyReport 8");

        let totalUsers = totalUserStats;
        userStats.forEach(userStat => {
            if(userStat.date){
                resultToWrite[userStat.date.toDateString()]['newUser'] = userStat.count;
                totalUsers = totalUsers - userStat.count;
                resultToWrite[userStat.date.toDateString()]['totalUsers'] = totalUsers;
            }
        });

        console.log("=> dailyReport 9");

        var totalSubscriber = totalSubscriberStats;
        susbcriberStats.forEach(subsc => {
            if(subsc.date){
                resultToWrite[subsc.date.toDateString()]['newSubscriber'] = subsc.count;
                totalSubscriber = totalSubscriber - subsc.count;
                resultToWrite[subsc.date.toDateString()]['totalSubscribers'] = totalSubscriber;
            }
        });

        console.log("=> dailyReport 10");

        let totalExpiredCountt = totalExpiredCount;

        billingStats.forEach(billingHistor => {
            // console.log(billingHistor);
            if(resultToWrite[billingHistor.date.toDateString()] && billingHistor._id["billing_status"] === "Success") {
                console.log("billingHistor",billingHistor);
                if (billingHistor._id.package_id === "QDfC") {
                    resultToWrite[billingHistor.date.toDateString()]['revenue-liveonly'] = billingHistor.revenue;
                    resultToWrite[billingHistor.date.toDateString()]['users-billed-liveonly'] = billingHistor.count;
                }
                if (billingHistor._id.package_id === "QDfG") {
                    resultToWrite[billingHistor.date.toDateString()]['revenue-liveweekly'] = billingHistor.revenue;
                    resultToWrite[billingHistor.date.toDateString()]['users-billed-liveweekly'] = billingHistor.count;
                }
                if (billingHistor._id.package_id === "QDfH") {
                    resultToWrite[billingHistor.date.toDateString()]['revenue-comedyonly'] = billingHistor.revenue;
                    resultToWrite[billingHistor.date.toDateString()]['users-billed-comedyonly'] = billingHistor.count;
                }
                if (billingHistor._id.package_id === "QDfI") {
                    resultToWrite[billingHistor.date.toDateString()]['revenue-comedyweekly'] = billingHistor.revenue;
                    resultToWrite[billingHistor.date.toDateString()]['users-billed-comedyweekly'] = billingHistor.count;
                }
            } else if (resultToWrite[billingHistor.date.toDateString()] && billingHistor._id["billing_status"] === "expired")  {
                console.log("[dailyReport]expired On the day",billingHistor.count);
                console.log("[dailyReport]date",billingHistor.date.toDateString());
                totalExpiredCountt = totalExpiredCountt - billingHistor.count;
                console.log("[dailyReport]totalExpiredCountt",totalExpiredCountt);
                resultToWrite[billingHistor.date.toDateString()]['users_expired'] = billingHistor.count;
                resultToWrite[billingHistor.date.toDateString()]['users_expired_till_today'] = totalExpiredCountt;
            }
        });
        console.log("=> dailyReport 11");

        trialStats.forEach(trialStat => {
            if(resultToWrite[trialStat.date.toDateString()]) {
                resultToWrite[trialStat.date.toDateString()]['trials'] = trialStat.trials;
            }
        });

        console.log("=> dailyReport 12");

        // console.log("myDate",dayBeforeYesterday.toDateString());
        // console.log("myToday",resultToWrite[dayBeforeYesterday.toDateString()]);
        resultToWrite[dayBeforeYesterday.toDateString()]["tempTotalActiveSubscribers"] = totalActiveSubscribers; 

        for (res in resultToWrite) {
            let liveOnlyRevenue = (resultToWrite[res]["revenue-liveonly"])?resultToWrite[res]["revenue-liveonly"]:0;
            let liveWeeklyRevenue = (resultToWrite[res]["revenue-liveweekly"])?resultToWrite[res]["revenue-liveweekly"]:0;
            let comedyOnlyRevenue = (resultToWrite[res]["revenue-comedyonly"])?resultToWrite[res]["revenue-comedyonly"]:0 ;
            let comedyWeeklyRevenue = (resultToWrite[res]["revenue-comedyweekly"])?resultToWrite[res]["revenue-comedyweekly"]:0 ;
            
            let totalRevenue = liveOnlyRevenue + liveWeeklyRevenue + comedyOnlyRevenue + comedyWeeklyRevenue;
            
            let temp = {date: res, newUser: resultToWrite[res].newUser , newSubscriber: resultToWrite[res].newSubscriber,
                liveOnlyCount: resultToWrite[res]["users-billed-liveonly"],
                liveOnlyRevenue: liveOnlyRevenue,
                
                liveWeeklyCount: resultToWrite[res]["users-billed-liveweekly"],
                liveWeeklyRevenue: liveWeeklyRevenue,
                
                comedyOnlyCount: resultToWrite[res]["users-billed-comedyonly"],
                comedyOnlyRevenue: comedyOnlyRevenue,
                
                comedyWeeklyCount: resultToWrite[res]["users-billed-comedyweekly"],
                comedyWeeklyRevenue: comedyWeeklyRevenue,
                
                users_billed: resultToWrite[res].users_billed, trials: resultToWrite[res].trials,tempTotalActiveSubscribers: (resultToWrite[res]["tempTotalActiveSubscribers"])?resultToWrite[res]["tempTotalActiveSubscribers"]:"",
                totalUsers : resultToWrite[res].totalUsers, totalSubscribers: resultToWrite[res].totalSubscribers, 
                totalActiveSubscribers : (resultToWrite[res].totalSubscribers - resultToWrite[res].users_expired_till_today < 0)? 0 : resultToWrite[res].totalSubscribers - resultToWrite[res].users_expired_till_today,
                totalRevenue:  totalRevenue       
            }
            resultToWriteToCsv.push(temp);
        } 

        console.log("=> dailyReport 13");

    }catch(err){
        console.log("=> catch ", err);
    }

    try {  
        csvWriter.writeRecords(resultToWriteToCsv).then(async (data) => {
            var info = await transporter.sendMail({
                from: 'paywall@dmdmax.com.pk', // sender address
                //to:  ['farhan.ali@dmdmax.com'],
                to:  ["yasir.rafique@dmdmax.com","paywall@dmdmax.com.pk","mikaeel@dmdmax.com","zara.naqi@telenor.com.pk", "fahad.shabbir@ideationtec.com","ceo@ideationtec.com","asad@ideationtec.com","usama.abbasi@ideationtec.com","wasif@dmdmax.com"], // list of receivers
                subject: `Paywall Report`, // Subject ne
                text: `PFA some basic stats for Paywall - ${(new Date()).toDateString()}`, // plain text bodyday
                attachments:[
                    {
                        filename: paywallRevFileName,
                        path: paywallRevFilePath
                    }
                ]
            });
            console.log("=> dailyReport 14",info);
            fs.unlink(paywallRevFilePath,function(err,data) {
                if (err) {
                    console.log("=> [dailyReport]File not deleted");
                }
                console.log("=> [dailyReport]data");
            });
            console.log("=> [dailyReport]info",info);
        }).catch(er => {
            console.log("=> [dailyReport]err",er)
        });
        console.log("=> [dailyReport]resultToWrite",resultToWriteToCsv)
    } catch(err) {
        console.log("=> [dailyReport]",err);
    }
}

callBacksReport =async() => {
    try { 
        let startDate = new Date("2020-06-19T00:00:00.000Z");
        let report =  await Subscription.aggregate([ 
            { 
                $match: {
                        $or:[{source: "HE"},{source: "affiliate_web"}],
                        added_dtm: { $gte: startDate }
                    } 
            },
            {
                $lookup:  
                    {        
                        from: "billinghistories",        
                        localField: "_id",        
                        foreignField: "subscription_id",        
                        as: "histories" 
                    } 
            },
            { 
                $project: { 
                    tid: "$affiliate_unique_transaction_id",
                    mid: "$affiliate_mid",
                    added_dtm: "$added_dtm",
                    active: "$active",
                    callbackhistory: {
                            $filter: {
                                input: "$histories",
                                as: "histor",
                                cond: {$eq: ["$$histor.billing_status", "Affiliate callback sent" ] }
                            }
                    }
                }
            }, 
            { 
                $project: { 
                tid: "$tid",
                mid: "$mid",
                isValidUser: {$cond: {if: {$eq:["$active",true]}, then: true, else: false } },
                added_dtm: "$added_dtm",
                callbackhistorySize: {"$size": "$callbackhistory" },
                callbackObj: {$arrayElemAt: ["$callbackhistory",0]},
                added_dm: { '$dateToString' : { date: "$added_dtm",'format':'%Y-%m-%d-%H:%M:%S','timezone' : "Asia/Karachi" } },
                }
            },
            { 
                $project: { 
                tid: "$tid",
                mid: "$mid",
                isValidUser: "$isValidUser",
                callbackhistorySize: "$callbackhistorySize",
                added_dm: { '$dateToString' : { date: "$added_dtm",'format':'%Y-%m-%d-%H:%M:%S','timezone' : "Asia/Karachi" } },
                billing_dm: { '$dateToString' : { date: "$callbackObj.billing_dtm",'format':'%Y-%m-%d-%H:%M:%S','timezone' : "Asia/Karachi" } }
                }
            }, 
            { 
                $project: { 
                tid: "$tid",
                mid: "$mid",
                isValidUser: "$isValidUser",
                added_dtm:  {$cond: {if: "$isValidUser", then: "$added_dm" , else: "" } },
                isCallbAckSent: {$cond: { if: { $and: [{$gte: ["$callbackhistorySize",1]},{$eq: [ "$isValidUser",true ]} ] } ,then:"yes",else:"no" }} ,
                callBackSentTime: {$cond: {if: "$isValidUser", then: "$billing_dm" , else: "" } }  
                }
            }
        ]);

        let write = await csvReportWriter.writeRecords(report);
        var info = await transporter.sendMail({
            from: 'paywall@dmdmax.com.pk', // sender address
            // to:  ["paywall@dmdmax.com.pk"],
            to:  ["paywall@dmdmax.com.pk","nauman@dmdmax.com","mikaeel@dmdmax.com"], // list of receivers
            subject: `Callbacks Report`, // Subject line
            text: `Callbacks sent with their TIDs and timestamps -  ${(new Date()).toDateString()}`, // plain text bodyday
            attachments:[
                {
                    filename: paywallCallbackReport,
                    path: paywallCallbackFilePath
                }
            ]
        });
        console.log("***> Report",info);
        fs.unlink(paywallCallbackFilePath,function(err,data) {
            if (err) {
                console.log("***> File not deleted");
            }
            console.log("***> data",data);
        });
    } catch(err) {
        console.log("***> Error", err);
    }
    
}

const errorCountReportBySource = createCsvWriter({
    path: paywallErrorCountBySourceFilePath,
    header: [
        {id: 'source', title: 'Source'},
        {id: 'errorMessage', title: 'Error Message'},
        {id: 'errorCode', title: 'Error Code'},
        {id: "count",title: "Error Count" }
    ]
});

const errorCountReportWriter = createCsvWriter({
    path: paywallErrorCountFilePath,
    header: [
        {id: 'errorMessage', title: 'Error Message'},
        {id: 'errorCode', title: 'Error Code'},
        {id: "count",title: "Error Count" }
    ]
});

const dailyUnsubReportWriter = createCsvWriter({
    path: paywallUnsubFilePath,
    header: [
        {id: 'date', title: 'Date'},
        {id: "count",title: "Unsubscribe Count" },
        {id: "source",title: "Source" }
    ]
});

const dailyChannelWiseUnsubWriter = createCsvWriter({
    path: paywallChannelWiseUnsubReportFilePath,
    header: [
        {id: 'date', title: 'Date'},
        {id: 'app', title: 'App'},
        {id: 'web', title: 'Web'},
        {id: 'sms', title: 'Sms'},
        {id: 'cc', title: 'Customer Care'},
        {id: 'cp', title: 'Customer Portal'},
        {id: 'expired', title: 'Expired By System'},
        {id: "total",title: "Total" }
    ]
});

const dailyChannelWiseTrialWriter = createCsvWriter({
    path: paywallChannelWiseTrialFilePath,
    header: [
        {id: 'date', title: 'Date'},
        {id: 'app', title: 'App'},
        {id: 'web', title: 'Web'},
        {id: 'HE', title: 'Affiliate'},
        {id: "total",title: "Total" }
    ]
});

errorCountReport = async() => {
    try {
        let errorBySourceReport = await billinghistoryRepo.errorCountReportBySource();
        console.log("=> done 1");
        let errorReport = await billinghistoryRepo.errorCountReport();
        console.log("=> done 2");
        
        await errorCountReportWriter.writeRecords(errorReport);
        await errorCountReportBySource.writeRecords(errorBySourceReport);
        var info = await transporter.sendMail({
            from: 'paywall@dmdmax.com.pk', // sender address
            to:  ["farhan.ali@dmdmax.com"],
            //to:  ["paywall@dmdmax.com.pk","mikaeel@dmdmax.com"], // list of receivers
            subject: `Daily Error Reports`, // Subject line
            text: `This report (generated at ${(new Date()).toDateString()}) contains all error count stats from 23rd February 2020 onwards.`, // plain text bodyday
            attachments:[
                {
                    filename: paywallErrorCountReport,
                    path: paywallErrorCountFilePath
                },
                {
                    filename: paywallErrorCountReportBySource,
                    path: paywallErrorCountBySourceFilePath
                }
            ]
        });
        console.log("=> [errorCountReport][emailSent]",info);
        fs.unlink(paywallErrorCountFilePath,function(err,data) {
            if (err) {
                console.log("File not deleted[errorCountReport]");
            }
            console.log("File deleted [errorCountReport]");
        });
        fs.unlink(paywallErrorCountBySourceFilePath,function(err,data) {
            if (err) {
                console.log("File not deleted[errorCountReportBySource]");
            }
            console.log("File deleted [errorCountReportBySource]");
        });
    } catch (error) {
        console.error("=>", error);
    }
}

dailyUnsubReport = async(from,to) => {
    try {
        let dailyUnsubReport = await billinghistoryRepo.dailyUnsubReport();
        await dailyUnsubReportWriter.writeRecords(dailyUnsubReport);
        var info = await transporter.sendMail({
            from: 'paywall@dmdmax.com.pk', // sender address
            // to:  ["hamza@dmdmax.com"],
            to:  ["paywall@dmdmax.com.pk"], // list of receivers
            subject: `Daily Unsubscribed Users Report`, // Subject line
            text: `This report (generated at ${(new Date()).toDateString()}) contains count of unsubscribed users.`, // plain text bodyday
            attachments:[
                {
                    filename: paywallUnsubReport,
                    path: paywallUnsubFilePath
                }
            ]
        });
        console.log("[dailyUnsubReport][emailSent]",info);
        fs.unlink(paywallUnsubFilePath,function(err,data) {
            if (err) {
                console.log("File not deleted[dailyUnsubReport]");
            }
            console.log("File deleted [dailyUnsubReport]");
        });
    } catch (error) {
        console.error(error);
    }
}

dailyNetAddition = async(from, to) => {
    try {
        let csvData = [];

        console.log("=> from", from, "to", to);
        let dailySubscriptions = await subscriptionRepo.getAllSubscriptionsByDate(from, to);
        let dailyUnSubscriptions = await billinghistoryRepo.unsubReport(from, to);

        for(let i = 0; i < dailySubscriptions.length; i++){
            let data = {};
            data.date = dailySubscriptions[i].date;
            if(new Date(dailySubscriptions[i].date).getTime() === new Date(dailyUnSubscriptions[i].date).getTime()){
                data.subs = dailySubscriptions[i].count;
                data.unsubs = dailyUnSubscriptions[i].count;
                data.net = (dailySubscriptions[i].count - dailyUnSubscriptions[i].count);
                csvData.push(data);
            }
        }

        await dailyNetAdditionWriter.writeRecords(csvData);
        console.log("=> Daily Addition Report");
        from = new Date(from);
        let info = await transporter.sendMail({
            from: 'paywall@dmdmax.com.pk',
            to:  ["farhan.ali@dmdmax.com"],
            // to:  ["paywall@dmdmax.com.pk", "zara.naqi@telenor.com.pk", "mikaeel@dmdmax.com", "khurram.javaid@telenor.com.pk", "junaid.basir@telenor.com.pk"], // list of receivers
            subject: `Daily Net Additions - ${monthNames[from.getMonth()]}`,
            text: `This report contains daily net additions for the month of ${monthNames[from.getMonth()]}.`,
            attachments:[
                {
                    filename: dailyNetAdditionCsv,
                    path: dailyNetAdditionFilePath
                }
            ]
        });
        console.log("=> [dailyNetAdditionCsv][emailSent]",info);
        fs.unlink(dailyNetAdditionFilePath,function(err,data) {
            if (err) {
                console.log("=> File not deleted[dailyNetAdditionCsv]");
            }
            console.log("=> File deleted [dailyNetAdditionCsv]");
        });
    } catch (error) {
        console.error("=> error ", error);
    }
}

avgTransactionPerCustomer = async(from, to) => {
    try {
        console.log("=> AvgTransactionPerCustomer from", from, "to", to);
        let totalTransactions = await billinghistoryRepo.numberOfTransactions(from, to);
        totalTransactions = totalTransactions[0].count;

        let totalUniqueUsers = await billinghistoryRepo.totalUniqueTransactingUsers(from, to);
        totalUniqueUsers = totalUniqueUsers[0].count;

        let avgTransactions = totalTransactions / totalUniqueUsers;

        console.log("=> Avg. Transactions Per Customer Report");
        from = new Date(from);
        let info = await transporter.sendMail({
            from: 'paywall@dmdmax.com.pk',
            to:  ["farhan.ali@dmdmax.com"],
            // to:  ["paywall@dmdmax.com.pk", "zara.naqi@telenor.com.pk", "mikaeel@dmdmax.com", "khurram.javaid@telenor.com.pk", "junaid.basir@telenor.com.pk"], // list of receivers
            subject: `Avg Transactions/Customer - ${monthNames[from.getMonth()]}`,
            text: `Avg Transactions/Customer for the month of ${monthNames[from.getMonth()]} are ${avgTransactions}`,
        });
        console.log("=> [avgTransactionPerCustomer][emailSent]",info);
    } catch (error) {
        console.error("=> avgTransactionPerCustomer- error ", error);
    }
}

weeklyRevenue = async(weekFromArray, weekToArray, emailList) => {
    try {
        let emailBody = "";

        for(let i = 0; i < weekFromArray.length; i++){
            let weekFrom = weekFromArray[i];
            let weekTo = weekToArray[i];

            console.log("=> weeklyRevenue from", weekFrom, "to", weekTo);
            let revenue = await billinghistoryRepo.getRevenueInDateRange(weekFrom, weekTo);
            emailBody = emailBody.concat(`${weekFrom} - ${weekTo}:   ${revenue[0].total}\n`);
        }

        let info = await transporter.sendMail({
            from: 'paywall@dmdmax.com.pk',
            to:  emailList,
            subject: `Weekly Revenue Report - ${monthNames[weekFromArray[0].getMonth()]}`,
            text: emailBody,
        });
        console.log("=> [weeklyRevenue][emailSent]",info);
        
    } catch (error) {
        console.error("=> weeklyRevenue- error ", error);
    }
}

weeklyTransactingCustomers = async(weekFromArray, weekToArray, emailList) => {

    try {
        let emailBody = "";

        for(let i = 0; i < weekFromArray.length; i++){
            let weekFrom = weekFromArray[i];
            let weekTo = weekToArray[i];

            console.log("=> weeklyTransactingCustomers from", weekFrom, "to", weekTo);
            let totalUniqueUsers = await billinghistoryRepo.totalUniqueTransactingUsers(weekFrom, weekTo);
            emailBody = emailBody.concat(`${weekFrom} - ${weekTo}:   ${totalUniqueUsers[0].count}\n`);
        }

        let info = await transporter.sendMail({
            from: 'paywall@dmdmax.com.pk',
            to:  emailList,
            subject: `Weekly Transacting Customers - ${monthNames[weekFromArray[0].getMonth()]}`,
            text: emailBody,
        });
        console.log("=> [weeklyTransactingCustomers][emailSent]",info);
        
    } catch (error) {
        console.error("=> weeklyTransactingCustomers- error ", error);
    }
}

dailyReturningUsers = async(from, to) => {
    try {
        console.log("=> DailyReturningUsers from", from, "to", to);
        let dailyReturningUsers = await billinghistoryRepo.dailyReturningUsers(from, to);
        console.log("=> DailyReturningUsers", dailyReturningUsers);
        let dailyReturningUsersCount = dailyReturningUsers[0].totalcount;
        console.log(`=> Daily Returning Users for ${to} are ${dailyReturningUsersCount}`);
        
        let info = await transporter.sendMail({
            from: 'paywall@dmdmax.com.pk',
            //to:  ["farhan.ali@dmdmax.com"],
            to:  ["paywall@dmdmax.com.pk","mikaeel@dmdmax.com"],
            subject: `Daily Returning Users`,
            text: `Daily returning users for the date ${to} are ${dailyReturningUsersCount}`,
        });
        console.log("=> [dailyReturningUsers][emailSent]",info);
    } catch (error) {
        console.error("=> dailyReturningUsers- error ", error);
    }
}

dailyChannelWiseUnsub = async() => {
    try {
        console.log("=> [dailyChannelWiseUnsub]");
        let records = [];
        let dailyChannelWiseUnsub = await billinghistoryRepo.dailyChannelWiseUnsub(); 
        console.log("=> done 1"); 
        let dailyExpiredBySystem = await billinghistoryRepo.dailyExpiredBySystem();
        console.log("=> done 2");

        dailyChannelWiseUnsub.forEach(element => {
            let date = element.date;
            let source = element.source;
            let count = element.count;
            
            let present = isDatePresent(records, date);
            if(present){
                if(source === "app" || source == "na"){
                    present.app = (present.app + count);
                    present.total = (present.total + count);
                }else if(source === "web"){
                    present.web = (present.web + count);
                    present.total = (present.total + count);
                }else if(source === "sms"){
                    present.sms = (present.sms + count);
                    present.total = (present.total + count);
                }else if(source === "CC"){
                    present.cc = (present.cc + count);
                    present.total = (present.total + count);
                }else if(source === "CP"){
                    present.cp = (present.cp + count);
                    present.total = (present.total + count);
                }
            }else{
                let expiredBySystem = isDatePresent(dailyExpiredBySystem, date);
                let app = (source === "app" || source == "na") ? count : 0;
                let web = source === "web" ? count : 0;
                let sms = source === "sms" ? count : 0;
                let cc = source === "CC" ? count : 0;
                let cp = source === "CP" ? count : 0;
                let expired = expiredBySystem !== undefined ? expiredBySystem.count : 0;

                let total = (app + web + sms + cc + cp + expired);

                let object = {date: date, app: app, web: web, sms: sms, cc: cc, cp: cp, expired: expired, total: total};
                records.push(object);
            }
            
        });

        await dailyChannelWiseUnsubWriter.writeRecords(records);
        console.log("=> done 3");
        var info = await transporter.sendMail({
            from: 'paywall@dmdmax.com.pk', // sender address
            // to:  ["farhan.ali@dmdmax.com"],
            to:  ["paywall@dmdmax.com.pk","nauman@dmdmax.com"], // list of receivers
            subject: `Daily Source Wise Unsubscribed Users Report`, // Subject line
            text: `This report (generated at ${(new Date()).toDateString()}) contains count of unsubscribed users with respect to source.\n\nNote: Expired By System column indicates those users expired by the system because their grace time is over and they still have no balance.`, // plain text bodyday
            attachments:[
                {
                    filename: paywallChannelWiseUnsubReport,
                    path: paywallChannelWiseUnsubReportFilePath
                }
            ]
        });
        console.log("=> [dailyChannelWiseUnsub][emailSent]",info);
        fs.unlink(paywallChannelWiseUnsubReportFilePath,function(err,data) {
            if (err) {
                console.log("=> File not deleted[dailyChannelWiseUnsub]");
            }
            console.log("=> File deleted [dailyChannelWiseUnsub]");
        });
    } catch (error) {
        console.error("=>", error);
    }
}

dailyChannelWiseTrialActivated = async() => {
    try {
        console.log("[dailyChannelWiseTrialActivated]");
        let records = [];
        let dailyChannelWiseTrial = await billinghistoryRepo.dailyChannelWiseTrialActivated(); 

        dailyChannelWiseTrial.forEach(element => {
            let date = element.date;
            let source = element.source;
            let count = element.count;
            
            let present = isDatePresent(records, date);
            if(present){
                if(source === "app"){
                    present.app = (present.app + count);
                    present.total = (present.total + count);
                }else if(source === "web"){
                    present.web = (present.web + count);
                    present.total = (present.total + count);
                }else if(source === "HE"){
                    present.HE = (present.HE + count);
                    present.total = (present.total + count);
                }
            }else{
                let app = source === "app" ? count : 0;
                let web = source === "web" ? count : 0;
                let HE = source === "HE" ? count : 0;
                let total = (app + web + HE);

                let object = {date: date, app: app, web: web, HE: HE, total: total};
                records.push(object);
            }
            
        });

        await dailyChannelWiseTrialWriter.writeRecords(records);

        var info = await transporter.sendMail({
            from: 'paywall@dmdmax.com.pk', // sender address
            // to:  ["paywall@dmdmax.com.pk"],
            to:  ["paywall@dmdmax.com.pk","mikaeel@dmdmax.com"], // list of receivers
            subject: `Source Wise Trial Activated Report`, // Subject line
            text: `This report (generated at ${(new Date()).toDateString()}) contains count of trials activated with respect to source.`, // plain text bodyday
            attachments:[
                {
                    filename: paywallChannelWiseTrial,
                    path: paywallChannelWiseTrialFilePath
                }
            ]
        });
        console.log("[dailyChannelWiseTrialActivated][emailSent]",info);
        fs.unlink(paywallChannelWiseTrialFilePath,function(err,data) {
            if (err) {
                console.log("File not deleted[paywallChannelWiseTrial]");
            }
            console.log("File deleted [dailyChannelWiseTrialActivated]");
        });
    } catch (error) {
        console.error(error);
    }
}

function isDatePresent(array, dateToFind) {
    const result = array.find(o => new Date(o.date).getTime() === new Date(dateToFind).getTime());
    return result;
}

function isMultipleDatePresent(array, date1ToFind) {
    let newDate1ToFind = new Date(date1ToFind);

    const result = array.find(o =>
         new Date(o.trial_date).getTime() === newDate1ToFind.getTime()
         );
    return result;
}

dailyTrialToBilledUsers = async() => {
    try {
        console.log("=> dailyTrialToBilledUsers");
        let trialToBilled = await subscriptionRepo.dailyTrialToBilledUsers();
        let trialToBilledUsers = [];

        trialToBilled.forEach(element => {
            let trialDate = undefined;
            let BreakException = {};

            console.log("=> dailyTrialToBilledUsers 2");
            try{
                console.log("=> dailyTrialToBilledUsers 3");
                element.usershistory.forEach(subElement => {
                    if(subElement.billing_status === 'trial'){
                        trialDate = new Date(subElement.billing_dtm);
                        trialDate.setHours(0, 0, 0, 0);
                    }else if(subElement.billing_status === 'Success'){
                        let billingDate = new Date(subElement.billing_dtm);
                        billingDate.setHours(0, 0, 0, 0);

                        var trialNextDay = new Date(trialDate);
                        trialNextDay.setDate(trialNextDay.getDate() + 1);

                        if(trialNextDay.getTime() === billingDate.getTime()){
                            // Means user is billed right after next day of trial
                            let currentObj = isMultipleDatePresent(trialToBilledUsers, trialDate);
                            if(currentObj){
                                currentObj.msisdn.push({"msisdn":element.msisdn});
                                currentObj.total = (currentObj.total + 1);
                            }else{
                                //console.log('trialToBilledUsers', trialDate, ' --- ', trialNextDay, ' --- ', billingDate);
                                let object = {};
                                object.trial_date = trialDate;
                                object.billed_date = billingDate;
                                object.msisdn = [{"msisdn":element.msisdn}];
                                object.total = 1;
                                trialToBilledUsers.push(object);
                            }
                            throw BreakException;
                        }
                    }
                });
            }catch(e){
                if(e !== BreakException)
                    throw e;
            }
        });

        console.log("=> dailyTrialToBilledUsers 4");

        let today = new Date();
        today.setHours(today.getHours() - 24);
        today.setHours(0, 0, 0, 0);

        let lastTenDays = new Date();
        lastTenDays.setDate(lastTenDays.getDate() - 11);
        lastTenDays.setHours(0, 0, 0, 0);

        trialToBilledUsers.forEach(element => {
            element.msisdn = JSON.stringify(element.msisdn);
        });
        console.log("=> dailyTrialToBilledUsers 5");

        let trialToBilledUserToWr = trialToBilledUsers.sort(function (a,b){
            return   b['trial_date'] - a['trial_date'];
        })

        console.log("=> sending email");
        await csvTrialToBilledUsers.writeRecords(trialToBilledUserToWr);
        var info = await transporter.sendMail({
            from: 'paywall@dmdmax.com.pk',
            to:  ["farhan.ali@dmdmax.com"],
            //to:  ["paywall@dmdmax.com.pk", "nauman@dmdmax.com", "mikaeel@dmdmax.com"], // list of receivers
            subject: 'Trial To Billed Users',
            text: `This report (generated at ${(new Date()).toDateString()}) contains count of users who are directly billed after trial from ${lastTenDays} to ${today}.\nNote: You can ignore the current date row.`, // plain text bodyday
            attachments:[
                {
                    filename: paywallTrialToBilledUsers,
                    path: paywallTrialToBilledUsersFilePath
                }
            ]
        });
        console.log("=> [trialToBilledUsers][emailSent]", info);
        fs.unlink(paywallTrialToBilledUsersFilePath,function(err,data) {
            if (err) {
                console.log("=> File not deleted");
            }
            console.log("data");
        });
    } catch (error) {
        console.error(error);
    }
}

dailyFullAndPartialChargedUsers = async() => {
    try {
        console.log("=> dailyFullAndPartialChargedUsers");
        let dailyReport = await billinghistoryRepo.getDailyFullyChargedAndPartialChargedUsers();
        console.log("=> done 1");
        let array = [];

        dailyReport.forEach(element => {
            let obj = isDatePresent(array, element.date);
            if(!obj){
                obj = {date: element.date};
                array.push(obj);
            }

            if(element.micro_charge_state === true){
                obj.partially_charged_users = element.total;
            }else{
                obj.fully_charged_users = element.total;
            }
            obj.total = obj.total ? (obj.total + element.total) : element.total;
        });

        await csvFullAndPartialCharged.writeRecords(array);
        var info = await transporter.sendMail({
            from: 'paywall@dmdmax.com.pk',
            // to:  ["farhan.ali@dmdmax.com"],
            to:  ["paywall@dmdmax.com.pk",  "mikaeel@dmdmax.com", "nauman@dmdmax.com"], // list of receivers
            subject: 'Full & Partial Charged Users',
            text: `This report (generated at ${(new Date()).toDateString()}) contains count of full & partial charged users.`, // plain text bodyday
            attachments:[
                {
                    filename: paywallFullAndPartialChargedReport,
                    path: paywallFullAndPartialChargedReportFilePath
                }
            ]
        });
        console.log("=> [fullAndPartialChargedUsers][emailSent]", info);
        fs.unlink(paywallFullAndPartialChargedReportFilePath,function(err,data) {
            if (err) {
                console.log("=> File not deleted");
            }
            console.log("=> ", data);
        });
    } catch (error) {
        console.error("=>", error);
    }
}

dailyPageViews = async() => {
    console.log("***=> sending email")
    pageViews.connect().then(async(db) => {
        pageViews.getPageViews(db).then(async(pvs) => {
            console.log("***=>", pvs);
            await csvAffiliatePvs.writeRecords(pvs);
                var info = await transporter.sendMail({
                from: 'paywall@dmdmax.com.pk',
                // to:  ["hamza@dmdmax.com"],
                to:  ["paywall@dmdmax.com.pk","nauman@dmdmax.com", "mikaeel@dmdmax.com"], // list of receivers
                subject: 'Affiliate Page Views',
                text: `This report (generated at ${(new Date()).toDateString()}) contains affiliate page views`, // plain text bodyday
                attachments:[
                    {
                        filename: affiliatePvs,
                        path: affiliatePvsFilePath
                    }
                ]
            });
            console.log("***=> [csvAffiliatePvs][emailSent]", info);
            fs.unlink(affiliatePvsFilePath,function(err,data) {
                if (err) {
                    console.log("***=>File not deleted");
                }
                console.log("***=>", data);
            });
        }).catch(err => {
            console.log("***=>", err);
        });
        }).then(err => {
            console.log(err);
        });
}

getTotalUserBaseTillDate = async(from, to) => {
    let result = await usersRepo.getTotalUserBaseTillDate(from, to);
    await csvTotalBase.writeRecords(result);

    var info = await transporter.sendMail({
        from: 'paywall@dmdmax.com.pk', // sender address
        to:  ["paywall@dmdmax.com.pk", "mikaeel@dmdmax.com"],
        //to:  ["paywall@dmdmax.com.pk","zara.naqi@telenor.com.pk","mikaeel@dmdmax.com"], // list of receivers
        subject: `Paywall Total Base`, // Subject line
        text: `This report contains total user base from ${new Date(from)} to ${new Date(to)}.`,
        attachments:[
            {
                filename: paywallTotalBase,
                path: paywallTotalBaseFilePath
            }
        ]
    });
    console.log("[totalBase][emailSent]",info);
    fs.unlink(paywallTotalBaseFilePath,function(err,data) {
        if (err) {
            console.log("File not deleted[totalBase]");
        }
        console.log("File deleted [totalBase]");
    });
}

getExpiredBase = async() => {
    console.log('=> getExpiredBase');
    let result = await subscriptionRepo.getExpiredFromSystem();
    console.log('=> returned result counts ', result);
    let finalResult = [];
    for(let i = 0; i < result.length; i++){
        console.log('=>', result[i].userDetails.msisdn);
        finalResult.push({msisdn: result[i].userDetails.msisdn});
    }

    console.log('=> preparing csv - ', finalResult);

    await csvExpiredBase.writeRecords(finalResult);
    
    console.log('=> sending email');
    var info = await transporter.sendMail({
        from: 'paywall@dmdmax.com.pk', // sender address
        to:  ["farhan.ali@dmdmax.com"],
        subject: `5. Expired Base Msisdns`, // Subject line
        text: `This report contains total expired base i.e 7th Feb to date.`,
        attachments:[
            {
                filename: paywallExpiredBase,
                path: paywallExpiredBaseFilePath
            }
        ]
    });
    console.log("=> [expiredBase][emailSent]",info);
    fs.unlink(paywallExpiredBaseFilePath,function(err,data) {
        if (err) {
            console.log("=> File not deleted[expiredBase]");
        }
        console.log("=> File deleted [expiredBase]");
    });
}

getInactiveBase = async(from, to) => {
    let result = await usersRepo.getActiveUsers(from, to);

    let totalLength = result.length;
    let count = 0;
    console.log("*** Length: "+totalLength);

    let finalResult = [];
    let fiveDaysBack = new Date();
    fiveDaysBack.setDate(fiveDaysBack.getDate() - 7);

    let promise = new Promise((resolve, reject) => {
        result.forEach((user) => {
            getViewLogs(user._id).then((viewLog) => {
                console.log("*** Got result for ", user.msisdn);
    
                let latestLogTime = new Date(viewLog.added_dtm);
                if(fiveDaysBack.getTime() > latestLogTime.getTime()){
                    // Means 5 days passed user last visited app/web
                    finalResult.push({"msisdn": user.msisdn});
                }
            }).catch((err) => {
                //console.log("error ", err);
            }).finally(() => {
                console.log("*** Finally");
                count+=1;

                if (count === totalLength){
                    console.log("*** Resolved"); 
                    resolve();
                }
            });
        });
    });
    
    promise.then(async() => {
        console.log("*** ALL DONE");
        await csvInActiveBase.writeRecords(finalResult);

        var info = await transporter.sendMail({
            from: 'paywall@dmdmax.com.pk', // sender address
            to:  ["paywall@dmdmax.com.pk", "mikaeel@dmdmax.com"],
            //to:  ["paywall@dmdmax.com.pk","zara.naqi@telenor.com.pk","mikaeel@dmdmax.com"], // list of receivers
            subject: `Paywall InActive Base`, // Subject line
            text: `This report contains inactive base from ${new Date(from)} to ${new Date(to)}.\nInActive: Have not opened App/Web in last 7 days but are subscribed users`,
            attachments:[
                {
                    filename: paywallInActiveBase,
                    path: paywallInActiveBaseFilePath
                }
            ]
        });
        console.log("*** [paywallInActiveBase][emailSent]",info);
        fs.unlink(paywallInActiveBaseFilePath,function(err,data) {
            if (err) {
                console.log("*** File not deleted[paywallInActiveBase]");
            }
            console.log("*** File deleted [paywallInActiveBase]");
        });
    })
}

getUsersNotSubscribedAfterSubscribe = async() => {
    try{
        let result = await billinghistoryRepo.getUsersNotSubscribedAfterSubscribe();
        console.log("=> ALL DONE");
        await ActiveBaseWriter.writeRecords(result);

        var info = await transporter.sendMail({
            from: 'paywall@dmdmax.com.pk', // sender address
            to:  ["paywall@dmdmax.com.pk"],
            subject: `Users who subscribed in Jul but did subscribe in Aug`,
            text: `This report contains users who subscribed in Jul but did subscribe in Aug`,
            attachments:[
                {
                    filename: ActiveBase,
                    path: ActiveBaseFilePath
                }
            ]
        });

        console.log("=> [ActiveBaseFilePath][emailSent]",info);
        fs.unlink(ActiveBaseFilePath,function(err,data) {
            if (err) {
                console.log("=> File not deleted[ActiveBaseFilePath]");
            }
            console.log("=> File deleted [ActiveBaseFilePath]");
        });
    }catch(e){
        console.log("=>", e);
    }
}

getActiveBase = async(from, to) => {
    let result = await usersRepo.getActiveUsers(from, to);
    console.log("*** ALL DONE");
    await ActiveBaseWriter.writeRecords(result);

    var info = await transporter.sendMail({
        from: 'paywall@dmdmax.com.pk', // sender address
        to:  ["paywall@dmdmax.com.pk"],
        subject: `Paywall Active Base`, // Subject line
        text: `This report contains active base from ${new Date(from)} to ${new Date(to)}.`,
        attachments:[
            {
                filename: ActiveBase,
                path: ActiveBaseFilePath
            }
        ]
    });
    console.log("*** [ActiveBaseFilePath][emailSent]",info);
    fs.unlink(ActiveBaseFilePath,function(err,data) {
        if (err) {
            console.log("*** File not deleted[ActiveBaseFilePath]");
        }
        console.log("*** File deleted [ActiveBaseFilePath]");
    });
}

getInactiveBaseHavingViewLogsLessThan3 = async(from, to) => {
    let result = await usersRepo.getActiveUsers(from, to);
    let finalResult = [];
    let totalLength = result.length;
    let count = 0;
    console.log("*** Length: "+totalLength);

    let promise = new Promise((resolve, reject) => {
        result.forEach((user) => {
            getNumberOfViewLogs(user._id).then((count) => {
                console.log("*** Got result for ", user.msisdn, ' - ', count);
    
                if(count < 3){
                    // Means user visited app/web for once/twice
                    finalResult.push({"msisdn": user.msisdn});
                }
            }).catch((err) => {
                //console.log("error ", err);
            }).finally(() => {
                count+=1;

                if (count === totalLength){
                    console.log("*** Resolved"); 
                    resolve();
                }
            });
        });
    });
    
    promise.then(async() => {
        console.log("*** ALL DONE");
        await csvInActiveBase.writeRecords(finalResult);

        var info = await transporter.sendMail({
            from: 'paywall@dmdmax.com.pk', // sender address
            to:  ["paywall@dmdmax.com.pk", "mikaeel@dmdmax.com"],
            //to:  ["paywall@dmdmax.com.pk","zara.naqi@telenor.com.pk","mikaeel@dmdmax.com"], // list of receivers
            subject: `Paywall InActive Base`, // Subject line
            text: `This report  contains inactive base from ${new Date(from)} to ${new Date(to)}.\nInActive: Users who only opened app once/twice since subscribing.`,
            attachments:[
                {
                    filename: paywallInActiveBase,
                    path: paywallInActiveBaseFilePath
                }
            ]
        });
        console.log("*** [paywallInActiveBase][emailSent]",info);
        fs.unlink(paywallInActiveBaseFilePath,function(err,data) {
            if (err) {
                console.log("*** File not deleted[paywallInActiveBase]");
            }
            console.log("*** File deleted [paywallInActiveBase]");
        });
    })
}

generateUsersReportWithTrialAndBillingHistory = async(from, to) => {
    console.log("=> generateUsersReportWithTrialAndBillingHistory - from ", from, " to ", to);
    let finalResult = [];
    
    let aff_mids = [{affiliate_mid: "goonj"},{affiliate_mid: "1569"},{affiliate_mid: "gdn"},
        {affiliate_mid: "gdn2"},{affiliate_mid: "aff3"},{affiliate_mid: "aff3a"}
    ]

    let affMidsSubscriptions = await subscriptionRepo.getSubscriptionsForAffiliateMids(aff_mids, from, to);
    
    for(let i = 0; i < affMidsSubscriptions.length; i++){
        console.log("=> fetching data for affiliate mid ",affMidsSubscriptions[i]._id);
        let subscriber_ids = affMidsSubscriptions[i].subscriber_ids;
        let result = await billinghistoryRepo.getBillingDataForSpecificSubscriberIds(subscriber_ids);
        
        for(let j = 0; j < result.length; j++){
            console.log("=> user_id", result[j].user_id);
            
            let dataPresent = isDataPresent(finalResult, result[j].user_id);
            if(dataPresent){
                if(result[j].billing_status === "Success"){
                    dataPresent.success_transactions = dataPresent.success_transactions + 1;
                    dataPresent.amount = dataPresent.amount + result[j].price;
                }else if(result[j].billing_status === "trial"){
                    dataPresent.code = 0;
                }
            }else{
                let singleObject = {};
                singleObject.mid = affMidsSubscriptions[i]._id;
                singleObject.user_id = result[j].user_id;
                
                if(result[j].billing_status === "Success"){
                    singleObject.success_transactions = 1;
                    singleObject.amount = result[j].price;
                    singleObject.code = 1;
                }else if(result[j].billing_status === "trial"){
                    singleObject.success_transactions = 0;
                    singleObject.amount = 0;
                    singleObject.code = 0
                }
                finalResult.push(singleObject);
            }
        }
    }
    
    console.log("=>", JSON.stringify(finalResult));

    console.log("=> Sending email");
    await usersReportWithTrialAndBillingHistoryWriter.writeRecords(finalResult);
    let info = await transporter.sendMail({
        from: 'paywall@dmdmax.com.pk',
        to:  ["farhan.ali@dmdmax.com"],
        subject: `Users With Trial & Billing Details`, // Subject line
        text: `This report contains affiliate users with trial and billing details from ${new Date(from)} to ${new Date(to)}.\nNote: code 0 indicates trial and code 1 indicates subscribed directly`,
        attachments:[
            {
                filename: usersReportWithTrialAndBillingHistory,
                path: usersReportWithTrialAndBillingHistoryFilePath
            }
        ]
    });

    console.log("=> [usersReportWithTrialAndBillingHistory][emailSent]",info);
    fs.unlink(usersReportWithTrialAndBillingHistoryFilePath,function(err,data) {
        if (err) {
            console.log("=> File not deleted[usersReportWithTrialAndBillingHistory]");
        }
        console.log("=> File deleted [usersReportWithTrialAndBillingHistory]");
    });
}

generateReportForAcquisitionSourceAndNoOfTimeUserBilled = async() => {
    
    console.log("=> generateReportForAcquisitionSourceAndNoOfTimeUserBilled");
    let finalResult = [];
    let inputData = ["03430875776","03445468452","03445235824","03404811033","03457075606","03487811171","03414215391","03451005178","03149494502","03422269135","03481527024","03457571470","03476882993","03455757739","03474425537","03479336134","03438880900","03428273381","03460274032","03405458115","03482210863","03447610554","03454331969","03477344114","03487724754","03403199937","03135922773","03443384250","03480609290","03448861028","03023500251","03429724165","03466518773","03169551457","03480346761","03486883673","03404820727","03496055877","03484777970","03485271965","03466476538","03459610453","03417005605","03429840915","03454549335","03457384559","03496037421","03459038280","03444055091","03410093896","03443744800","03497602705","03448679535","03481082881","03488481958","03497983508","03417664061","03453830959","03407356551","03464112627","03418018606","03445297155","03451989245","03484224839","03485270943","03418692162","03457581077","03401227327","03419790981","03469410822","03454847498","03451053380","03462156419","03479232536","03458319209","03452914560","03460178356","03409561056","03475684664","03471693905","03474893328","03443732819","03448094797","03423840772","03128612001","03452199820","03440201264","03436725887","03070153693","03414996024","03432084218","03085278849","03464157962","03452114743","03454862376","03448213708","03468959334","03436531217","03454620292","03450065303","03467737876","03449488427","03421440974","03433011347","03438765919","03424354239","03429323235","03452701714","03477368027","03469525335","03445797007","03404420315","03482842372","03453594305","03416093789","03478223025","03239823060","03457528376","03465777177","03470479162","03444346499","03447419877","03457537960","03439333675","03481712843","03475847464","03494931172","03494939497","03444109767","03468823418","03457898312","03494769522","03487653753","03437816965","03405899940","03440328970","03490219461","03465774028","03214521894","03461888184","03431381272","03457296608","03423001035","03489848076","03453464601","03488722559","03479196621","03422968995","03417535639","03455810424","03443016285","03442139178","03405137637","03445897525","03469739775","03453788358","03497307591","03434178534","03460634612","03422733454","03340013838","03475916160","03422325261","03466292882","03452373690","03416644148","03486053332","03457981802","03484020345","03426566118","03416163819","03422294391","03442848600","03407558138","03439259040","03423462289","03481671495","03472951438","03425081817","03444790106","03448985065"];
    
    try{
        for(let i = 0; i < inputData.length; i++){
            let singleRecord = await usersRepo.getData(inputData[i]);
            if(singleRecord.length > 0){
                singleRecord = singleRecord[0];
                let singObject = {
                    msisdn: singleRecord.msisdn,
                    acquisition_date: singleRecord.acquisition_date,
                    number_of_success_charging: singleRecord.total_successful_chargings
                };

                if(singleRecord.acquisition_mid){
                    singObject.acquisition_source = singleRecord.acquisition_mid;
                }else{
                    if(singleRecord.acquisition_source === 'affiliate_web'){
                        singObject.acquisition_source = 'web';
                    }else{
                        singObject.acquisition_source = singleRecord.acquisition_source;
                    }
                    
                }
        
                let expiryHistory = {};
                if(singleRecord.subscription_status === 'expired'){
                    expiryHistory = await billinghistoryRepo.getExpiryHistory(singleRecord.user_id);
                    if(expiryHistory.length >= 2){
                        expiryHistory.sort(function(a,b){
                            return new Date(b.billing_dtm) - new Date(a.billing_dtm);
                        });
                    }
        
                    singObject.unsub_date = expiryHistory[0].billing_dtm;
                }
    
                finalResult.push(singObject);
                console.log("=> Data done for item ", i);
            }
        }
    
        console.log("=> Sending email");
        await randomReportWriter.writeRecords(finalResult);
        let info = await transporter.sendMail({
            from: 'paywall@dmdmax.com.pk',
            to:  ["farhan.ali@dmdmax.com"],
            subject: `Complaint Data`, // Subject line
            text: `This report contains the details of msisdns being sent us over email from Zara`,
            attachments:[
                {
                    filename: randomReport,
                    path: randomReportFilePath
                }
            ]
        });
    
        console.log("=> [randomReport][emailSent]",info);
        fs.unlink(randomReportFilePath,function(err,data) {
            if (err) {
                console.log("=> File not deleted[randomReport]");
            }
            console.log("=> File deleted [randomReport]");
        });
    }catch(e){
        console.log("=> error - ",JSON.stringify(e));
    }
}

getOnlySubscriberIds = async(source, from, to) => {
    try{
        from = new Date(from);
        to = new Date(to);
        let ids = await subscriptionRepo.getOnlySubscriberIds(source, from, to);
        console.log("=> dateWiseChargingDetails - 1");

        let details = await billinghistoryRepo.getChargingDetails(ids, from, to);
        console.log("=> Sending email");
        await dateWiseChargingDetailsWriter.writeRecords(details);

        let info = await transporter.sendMail({
            from: 'paywall@dmdmax.com.pk',
            to:  ["farhan.ali@dmdmax.com"],
            subject: `Day-wise Charging Details For ${source} - ${monthNames[from.getMonth()]}`, // Subject line
            text: `This report containg charging details of ${source}, day-wise for the month of ${monthNames[from.getMonth()]}`,
            attachments:[
                {
                    filename: dateWiseChargingDetails,
                    path: dateWiseChargingDetailsFilePath
                }
            ]
        });

        console.log("=> [dateWiseChargingDetails][emailSent]",info);
        fs.unlink(dateWiseChargingDetailsFilePath,function(err,data) {
            if (err) {
                console.log("=> File not deleted[dateWiseChargingDetails]");
            }
            console.log("=> File deleted [dateWiseChargingDetails]");
        });
    }catch(e){
        console.log("=> Error [dateWiseChargingDetails]", e);
    }
    
}

function isDataPresent(array, user_id) {
    const result = array.find(o => o.user_id === user_id);
    return result;
}

function getViewLogs(user_id){
    return new Promise(async(resolve, reject) => {
        try{
            let viewLog = await viewLogsRepo.getLatestViewLog(user_id);
            if(viewLog){
                resolve(viewLog);
            }else{
                reject("Not found");
            }
        }catch(err){
            reject(err);
        }
    });
}

function getNumberOfViewLogs(user_id){
    return new Promise(async(resolve, reject) => {
        try{
            let viewLog = await viewLogsRepo.getNumberOfViewLogs(user_id);
            if(viewLog){
                resolve(viewLog);
            }else{
                reject("Not found");
            }
        }catch(err){
            reject(err);
        }
    });
}

function getCurrentDate(){
    var dateObj = new Date();
    var month = dateObj.getMonth() + 1; //months from 1-12
    var day = dateObj.getDate();
    var year = dateObj.getFullYear();
    let newdate = day + "-" + month + "-" + year;
    return newdate;
}

module.exports = {
    dailyReport: dailyReport,
    callBacksReport: callBacksReport,
    errorCountReport: errorCountReport,
    dailyUnsubReport: dailyUnsubReport,
    dailyFullAndPartialChargedUsers: dailyFullAndPartialChargedUsers,
    dailyTrialToBilledUsers: dailyTrialToBilledUsers,
    dailyChannelWiseUnsub: dailyChannelWiseUnsub,
    dailyChannelWiseTrialActivated: dailyChannelWiseTrialActivated,
    dailyPageViews: dailyPageViews,
    getTotalUserBaseTillDate: getTotalUserBaseTillDate,
    getExpiredBase: getExpiredBase,
    getInactiveBase: getInactiveBase,
    getInactiveBaseHavingViewLogsLessThan3: getInactiveBaseHavingViewLogsLessThan3,
    dailyNetAddition: dailyNetAddition,
    avgTransactionPerCustomer: avgTransactionPerCustomer,
    dailyReturningUsers: dailyReturningUsers,
    weeklyRevenue: weeklyRevenue,
    getActiveBase: getActiveBase,
    getOnlySubscriberIds: getOnlySubscriberIds,
    weeklyTransactingCustomers: weeklyTransactingCustomers,
    generateReportForAcquisitionSourceAndNoOfTimeUserBilled: generateReportForAcquisitionSourceAndNoOfTimeUserBilled,
    generateReportForAcquisitionSourceAndNoOfTimeUserBilled2: generateReportForAcquisitionSourceAndNoOfTimeUserBilled2,
    generateReportForAcquisitionSourceAndNoOfTimeUserBilled3: generateReportForAcquisitionSourceAndNoOfTimeUserBilled3,
    generateReportForAcquisitionSourceAndNoOfTimeUserBilled4: generateReportForAcquisitionSourceAndNoOfTimeUserBilled4,
    getUsersNotSubscribedAfterSubscribe: getUsersNotSubscribedAfterSubscribe,
    generateUsersReportWithTrialAndBillingHistory:generateUsersReportWithTrialAndBillingHistory
}